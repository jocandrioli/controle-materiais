
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerador de Carimbo - Acionamento GPON</title>

  <style>
    :root{
      --primary:#003366; --primary-2:#004d99; --accent:#ff6600; --info:#0066cc;
      --bg:#f5f5f5; --panel:#fafafa; --text:#333; --muted:#666; --border:#ddd; --border-2:#999;
      --radius:8px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:var(--bg);padding:20px;line-height:1.6;color:var(--text)}
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.1);overflow:hidden}
    .header{background:var(--primary);color:#fff;padding:20px;text-align:center}
    .header h1{font-size:24px;margin-bottom:5px}
    .header p{font-size:12px;opacity:.9}

    .header-section{background:#f9f9f9;padding:20px;border-bottom:2px solid var(--primary-2)}
    .header-section h2{color:var(--primary);font-size:16px;margin-bottom:15px}

    .section{margin-bottom:20px;padding:15px;border:1px solid var(--border);border-radius:4px;background:var(--panel)}
    .section-title{font-weight:700;color:var(--primary);margin-bottom:12px;font-size:14px;border-bottom:2px solid var(--accent);padding-bottom:8px}

    .dynamic-content{padding:20px}
    .dynamic-content .hint{color:var(--muted);text-align:center;padding:40px 20px}

    .form-group{margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-group.full{grid-template-columns:1fr}
    .form-group.three-col{grid-template-columns:1fr 1fr 1fr}

    label{display:block;font-size:12px;font-weight:700;margin-bottom:4px}
    input[type="text"],input[type="tel"],input[type="number"],input[type="time"],textarea,select{
      width:100%;padding:8px;border:1px solid var(--border-2);border-radius:4px;font-size:12px;font-family:Arial,sans-serif
    }
    textarea{resize:vertical;min-height:60px}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);background:#fffef0}

    .checkbox-group{display:flex;gap:15px;margin-top:8px;flex-wrap:wrap}
    .checkbox-group label{display:inline-flex;align-items:center;margin-bottom:0;font-weight:600}
    .checkbox-group input{width:auto;margin-right:6px}

    .actions{display:flex;gap:10px;margin-top:20px;justify-content:space-between;flex-wrap:wrap}
    button{padding:10px 20px;font-size:12px;border:0;border-radius:4px;cursor:pointer;font-weight:700;transition:.3s}
    .btn-generate{background:var(--accent);color:#fff;flex:1;min-width:160px}
    .btn-generate:hover{background:#e55a00}
    .btn-clear{background:#999;color:#fff;flex:1;min-width:160px}
    .btn-clear:hover{background:#777}
    .btn-copy{background:var(--info);color:#fff;flex:1;min-width:160px}
    .btn-copy:hover{background:#0052a3}

    .output-section{margin:20px;padding:15px;background:#f0f0f0;border:1px solid var(--border);border-radius:4px;display:none}
    .output-section.active{display:block}
    .output-section h3{color:var(--primary);margin-bottom:10px;font-size:14px}
    .output-text{
      background:#fff;padding:12px;border:1px solid var(--border-2);border-radius:4px;
      font-family:"Courier New",monospace;font-size:11px;line-height:1.6;max-height:300px;overflow-y:auto;
      white-space:pre-wrap;word-break:break-word
    }
    .success-message{background:#d4edda;color:#155724;padding:10px;border-radius:4px;margin-top:10px;font-size:12px;display:none}
    .success-message.show{display:block}

    .divider{height:1px;background:var(--border);margin:10px 0}
    .mini{font-size:11px;color:var(--muted)}

    @media (max-width:768px){
      .form-group{grid-template-columns:1fr}
      .form-group.three-col{grid-template-columns:1fr}
      .actions{flex-direction:column}
      button{width:100%}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìã Gerador de Carimbo - RS-CAPITAL</h1>
      <p>Sistema de Acionamento - GPON - Vivo Rede</p>
    </div>

    <!-- Base (sempre vis√≠vel) -->
    <div class="header-section">
      <h2>Dados Gerais (Preenchidos para todos os carimbos)</h2>
      <div id="baseForm"></div>
      <div class="mini">* Campos espec√≠ficos aparecem ap√≥s selecionar o tipo de carimbo.</div>
    </div>

    <!-- Formul√°rio din√¢mico (gerado por JSON) -->
    <div class="dynamic-content">
      <div id="dynamicRoot"></div>
    </div>

    <!-- Sa√≠da -->
    <div id="output" class="output-section">
      <h3>Carimbo de Texto Gerado</h3>
      <div class="output-text" id="outputText"></div>

      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn-copy" id="btnCopy" type="button">Copiar para √Årea de Transfer√™ncia</button>
        <button class="btn-copy" id="btnWhats" type="button" style="background:#25d366;">Enviar via WhatsApp</button>
      </div>

      <div class="success-message" id="successMessage">Texto copiado para a √°rea de transfer√™ncia!</div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * SCHEMA (JSON) - EDITE AQUI
     *****************************************************************/
    const SCHEMA = {
      app: {
        title: "Gerador de Carimbo - RS-CAPITAL",
        subtitle: "Sistema de Acionamento - GPON - Vivo Rede"
      },

      lists: {
        supervisors: [
          { name: "Alexandre Ilha", phone: "(51) 99753-4576" },
          { name: "Diego Jaworski",  phone: "(51) 99670-7110" },
          { name: "Diego Richter",   phone: "(51) 99754-9214" },
          { name: "Marcio Mendes",   phone: "(51) 99589-2075" },
          { name: "M√°rio Pereira",   phone: "(51) 99837-8234" },
          { name: "Rodrigo Duarte",  phone: "(51) 99758-7793" },
          { name: "Rodrigo Rosa",    phone: "(51) 99840-6074" }
        ],
        analysts: [
          "CARINA DE FATIMA CHUQUEL",
          "EDMILSON GARCIA RIEIRA",
          "EDUARDA PAIVA RODRIGUES",
          "JULIA DOS SANTOS DA SILVA",
          "MATHEUS ALVES CASTRO",
          "RAFAELA VERCH DIAS",
          "SILVIO LUIZ RACHOR PUTRIQUE"
        ],
        sites: [
          "RSCBM_G1N01","RSCBM_O1A01","RSCQU_G1I01","RSGUB_G1N01","RSPAE_G1B95","RSPAE_G1C01",
          "RSPAE_G1I22","RSPAE_G1I23","RSPAE_G1I24","RSPAE_G1I25","RSPAE_G1I26","RSPAE_G1I32",
          "RSPAE_G1I33","RSPAE_G1I35","RSPAE_G1I41","RSPAE_G1I47","RSPAE_G1I48","RSPAE_G1I51",
          "RSPAE_G1I55","RSPAE_G1I57","RSPAE_G1N42","RSPAE_G1N45","RSSLE_G1M01","RSSLE_O1A04"
        ],
        causes: [
          "Abalroamento","Furto","Acidente","Descarga","Vandalismo","Troca de poste",
          "Degrada√ß√£o / Infiltra√ß√£o","Defeito Splitter","Falha em atividade anterior",
          "Obra de terceiros","Interperie","Ataque de animais"
        ]
      },

      baseFields: [
        { id: "id_ocorrencia", label: "ID Ocorr√™ncia/OS CTO (BA/TT)", type: "text", placeholder: "Ex: 123456", group: "two" },

        {
          id: "carimbo_tipo",
          label: "Selecione o Tipo de Carimbo",
          type: "select",
          optionsFrom: "types",   // preenchido automaticamente com base em types abaixo
          group: "two"
        },

        { id: "supervisor", label: "SUPERVISOR", type: "datalist", listId: "supervisorList", listFrom: "supervisors", placeholder: "Nome do Supervisor", group: "two" },
        { id: "supervisor_tel", label: "Telefone Supervisor", type: "tel", placeholder: "(51) 9XXXX-XXXX", inputmode: "tel", group: "two" },

        { id: "tecnico", label: "T√âCNICO", type: "text", placeholder: "Nome do T√©cnico", group: "two" },
        { id: "tecnico_tel", label: "Telefone T√©cnico", type: "tel", placeholder: "(51) 9XXXX-XXXX", inputmode: "tel", group: "two" },

        { id: "analista_ccr", label: "Analista CCR", type: "datalist", listId: "analistaList", listFrom: "analysts", placeholder: "Digite para pesquisar ou selecione na lista", group: "full" }
      ],

      // Tipos (cada item gera a se√ß√£o e o carimbo)
      types: [
        {
          id: "acionamento",
          label: "1. Acionamento",
          title: "ACIONAMENTO",
          fields: [
            { id: "acionamento_prev_chegada", label: "Previs√£o de chegada ao SITE/ARO para medi√ß√µes", type: "time", group: "two" },
            { id: "acionamento_site", label: "Nome SITE/ARO para medi√ß√µes", type: "datalist", listId: "siteList", listFrom: "sites", placeholder: "Digite para pesquisar ou selecione na lista", group: "two" }
          ],
          stamp: (d) => [
            "1 ‚Äì ACIONAMENTO", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Previs√£o de chegada ao SITE/ARO para medi√ß√µes: ${d.acionamento_prev_chegada}`,
            `Nome SITE/ARO para medi√ß√µes: ${d.acionamento_site}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "deslocamento",
          label: "2. Deslocamento ao Ponto da Falha",
          title: "DESLOCAMENTO AO PONTO DA FALHA",
          fields: [
            { id: "deslocamento_km", label: "KM at√© o LOCAL da falha", type: "number", step: "0.1", placeholder: "Ex: 15.5", group: "two" },
            { id: "deslocamento_prev_chegada", label: "Previs√£o de chegada ao LOCAL da falha", type: "time", group: "two" },
            { id: "deslocamento_obs", label: "Observa√ß√µes", type: "textarea", placeholder: "Observa√ß√µes sobre o deslocamento", group: "full" }
          ],
          stamp: (d) => [
            "2 ‚Äì DESLOCAMENTO AO PONTO DA FALHA", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `KM at√© o LOCAL da falha: ${d.deslocamento_km} km`,
            `Previs√£o de chegada ao LOCAL da falha: ${d.deslocamento_prev_chegada}`,
            `Obs.: ${d.deslocamento_obs}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "recuperacao",
          label: "3. Recupera√ß√£o da Falha",
          title: "RECUPERA√á√ÉO DA FALHA",
          fields: [
            { id: "recuperacao_causa", label: "Causa raiz", type: "select", optionsFrom: "causes", group: "two" },
            { id: "recuperacao_prev_testes", label: "Previs√£o para solicita√ß√£o de testes", type: "time", group: "two" },
            { id: "recuperacao_endereco", label: "Endere√ßo da falha", type: "text", placeholder: "Rua, N√∫mero, Complemento", group: "two" },
            { id: "recuperacao_cabo", label: "Cabo / Capacidade / ARO", type: "text", placeholder: "Ex: DROP 4F, 12F, 24F, 36F, 48F, 72F, 144F", group: "two" },
            { id: "recuperacao_tratativas", label: "Tratativas realizadas", type: "textarea", placeholder: "Descreva as tratativas", group: "full" },
            { id: "recuperacao_obs", label: "Observa√ß√µes", type: "textarea", placeholder: "Observa√ß√µes gerais", group: "full" }
          ],
          stamp: (d) => [
            "3 ‚Äì RECUPERA√á√ÉO DA FALHA", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Causa raiz: ${d.recuperacao_causa}`,
            `Previs√£o para solicita√ß√£o de testes: ${d.recuperacao_prev_testes}`,
            `Endere√ßo da falha: ${d.recuperacao_endereco}`,
            `Cabo/Capacidade/ARO: ${d.recuperacao_cabo}`,
            `Tratativas realizadas: ${d.recuperacao_tratativas}`,
            `Obs.: ${d.recuperacao_obs}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "certificacao",
          label: "4. Certifica√ß√£o",
          title: "SOLICITA√á√ÉO DE CERTIFICA√á√ÉO",
          fields: [
            { id: "certificacao_tratativa", label: "Tratativa realizada", type: "textarea", placeholder: "Descri√ß√£o da tratativa realizada", group: "full" },
            { id: "certificacao_causa", label: "Causa", type: "select", optionsFrom: "causes", group: "two" },
            { id: "certificacao_material", label: "Material utilizado", type: "text", placeholder: "Ex: Conector SC, Fibra √≥ptica", group: "two" },
            { id: "certificacao_foto", label: "Foto em anexo", type: "radio", name: "certificacao_foto", options: ["Sim", "N√£o"], group: "full" }
          ],
          stamp: (d) => [
            "4 ‚Äì SOLICITA√á√ÉO DE CERTIFICA√á√ÉO", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Tratativa realizada: ${d.certificacao_tratativa}`,
            `Causa: ${d.certificacao_causa}`,
            `Material utilizado: ${d.certificacao_material}`,
            `Foto em anexo: ${d.certificacao_foto}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "complementar",
          label: "Complementar",
          title: "COMPLEMENTAR",
          fields: [
            { id: "complementar_motivo", label: "Motivo", type: "text", placeholder: "Motivo da complementa√ß√£o", group: "two" },
            { id: "complementar_info", label: "Informa√ß√£o", type: "text", placeholder: "Informa√ß√£o adicional", group: "two" },
            { id: "nova_previsao", label: "Nova previs√£o?", type: "radio", name: "nova_previsao", options: ["Sim", "N√£o"], group: "two" },
            { id: "complementar_previsao", label: "Previs√£o", type: "time", group: "two" }
          ],
          stamp: (d) => [
            "COMPLEMENTAR", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `Motivo: ${d.complementar_motivo}`,
            `Informa√ß√£o: ${d.complementar_info}`,
            `Nova previs√£o? ${d.nova_previsao}`,
            `Previs√£o: ${d.complementar_previsao}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "naofalha",
          label: "N√£o h√° Falha para Rede",
          title: "N√ÉO H√Å FALHA PARA REDE",
          fields: [
            { id: "naofalha_motivo", label: "Motivo da Improdutiva", type: "textarea", placeholder: "Descreva o motivo da improdutiva", group: "full" },
            { id: "naofalha_foto", label: "Foto em anexo", type: "radio", name: "naofalha_foto", options: ["Sim", "N√£o"], group: "two" },
            { id: "naofalha_gestor", label: "Ciente (Gestor VIVO Rede)", type: "text", value: "Jo√£o Andrioli", readonly: true, group: "two" }
          ],
          stamp: (d) => [
            "N√ÉO H√Å FALHA PARA REDE", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Motivo da improdutiva: ${d.naofalha_motivo}`,
            `Foto em anexo: ${d.naofalha_foto}`,
            `Ciente (Gestor VIVO Rede): ${d.naofalha_gestor}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "transbordo",
          label: "Transbordo",
          title: "TRANSBORDO",
          fields: [
            { id: "transbordota", label: "TA", type: "text", placeholder: "TA", group: "two" },
            { id: "transbordocontrato", label: "CONTRATO", type: "text", placeholder: "Contrato", group: "two" },
            { id: "transbordooperadora", label: "TRANSBORDO", type: "text", value: "VIVO", readonly: true, group: "two" }
          ],
          stamp: (d) => [
            "TRANSBORDO", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `TA: ${d.transbordota}`,
            `CONTRATO: ${d.transbordocontrato}`,
            `TRANSBORDO: ${d.transbordooperadora}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "prazo",
          label: "Prazo de Reparo",
          title: "PRAZO DE REPARO",
          fields: [
            { id: "prazoreparocargo", label: "Cargo", type: "text", value: "Coordenador", readonly: true, group: "two" },
            { id: "prazoreparonometel", label: "Nome / Telefone", type: "text", value: "Jo√£o Andrioli / 41 99244-9441", readonly: true, group: "two" },
            { id: "prazoreparosla", label: "SLA do evento", type: "text", placeholder: "Ex: 4h, 2h", group: "two" },
            { id: "prazoreparoobs", label: "Observa√ß√µes", type: "text", placeholder: "Observa√ß√µes", group: "two" }
          ],
          stamp: (d) => [
            "ESCALONAMENTO PRAZO REPARO", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Cargo: ${d.prazoreparocargo}`,
            `Nome/Tel.: ${d.prazoreparonometel}`,
            `SLA do evento: ${d.prazoreparosla}`,
            `Obs.: ${d.prazoreparoobs}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "cire",
          label: "CIRE",
          title: "INTERVEN√á√ÉO CIRE",
          fields: [
            { id: "cire_solicitante", label: "Solicitante", type: "text", placeholder: "Nome do Solicitante", group: "two" },
            { id: "cire_contato", label: "Meio de contato", type: "radio", name: "cire_contato", options: ["Telefone", "E-mail", "WhatsApp"], group: "two" },
            { id: "cire_motivo", label: "Motivo", type: "textarea", placeholder: "Descreva o motivo da interven√ß√£o CIRE", group: "full" },
            { id: "cire_info", label: "Informa√ß√£o", type: "textarea", placeholder: "Informa√ß√µes adicionais", group: "full" },
            { id: "cire_previsao", label: "Previs√£o", type: "time", group: "two" }
          ],
          stamp: (d) => [
            "INTERVEN√á√ÉO CIRE", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `Solicitante: ${d.cire_solicitante}`,
            `Meio de contato: ${d.cire_contato}`,
            `Motivo: ${d.cire_motivo}`,
            `Informa√ß√£o: ${d.cire_info}`,
            `Previs√£o: ${d.cire_previsao}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "escalonamento",
          label: "Escalonamento sem Equipe",
          title: "ESCALONAMENTO SEM EQUIPE",
          fields: [
            { id: "escalonamento_cargo", label: "Cargo", type: "text", value: "Coordenador", readonly: true, group: "two" },
            { id: "escalonamento_nome_tel", label: "Nome / Telefone", type: "text", value: "Jo√£o Andrioli / 41 99244-9441", readonly: true, group: "two" },
            { id: "escalonamento_sla", label: "SLA do evento", type: "text", placeholder: "Ex: 4h, 2h", group: "two" },
            { id: "escalonamento_obs", label: "Observa√ß√µes", type: "text", placeholder: "Observa√ß√µes", group: "two" }
          ],
          stamp: (d) => [
            "ESCALONAMENTO SEM EQUIPE", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `Cargo: ${d.escalonamento_cargo}`,
            `Nome/Tel.: ${d.escalonamento_nome_tel}`,
            `SLA do evento: ${d.escalonamento_sla}`,
            `Obs.: ${d.escalonamento_obs}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        },

        {
          id: "cto_defeito",
          label: "CTO com Defeito",
          title: "CTO COM DEFEITO",
          fields: [
            { id: "cto_defeito_site", label: "Nome SITE/ARO", type: "datalist", listId: "siteList", listFrom: "sites", placeholder: "Digite para pesquisar ou selecione na lista", group: "two" },
            { id: "cto_defeito_splitter", label: "Splitter", type: "text", placeholder: "Ex: SP001, SP144", group: "two" },
            { id: "cto_defeito_caixa", label: "Caixa", type: "text", placeholder: "Ex: G0001, G0099, GP0050", group: "two" },
            { id: "cto_defeito_endereco", label: "Endere√ßo", type: "text", placeholder: "Rua, N√∫mero, Complemento", group: "two" },
            { id: "cto_defeito_causa", label: "Causa", type: "select", optionsFrom: "causes", group: "two" },
            { id: "cto_defeito_tratativa", label: "Tratativa realizada", type: "textarea", placeholder: "Descreva a tratativa realizada", group: "full" },
            { id: "cto_defeito_material", label: "Material utilizado", type: "text", placeholder: "Ex: Conector SC, Fibra √≥ptica, Splitter", group: "full" }
          ],
          stamp: (d) => [
            "CTO COM DEFEITO", "",
            `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
            `SUPERVISOR: ${d.supervisor}`, `Telefone: ${d.supervisor_tel}`,
            `T√âCNICO: ${d.tecnico}`, `Telefone: ${d.tecnico_tel}`,
            `Nome SITE/ARO: ${d.cto_defeito_site}`,
            `Splitter: ${d.cto_defeito_splitter}`,
            `Caixa: ${d.cto_defeito_caixa}`,
            `Endere√ßo: ${d.cto_defeito_endereco}`,
            `Causa: ${d.cto_defeito_causa}`,
            `Tratativa realizada: ${d.cto_defeito_tratativa}`,
            `Material utilizado: ${d.cto_defeito_material}`,
            `Analista CCR: ${d.analista_ccr}`
          ]
        }
      ]
    };

    /*****************************************************************
     * Runtime (gera√ß√£o do formul√°rio)
     *****************************************************************/
    const $ = (id) => document.getElementById(id);

    const normalizeName = (str) =>
      (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

    const supervisorPhones = Object.fromEntries(
      SCHEMA.lists.supervisors.map(s => [normalizeName(s.name), s.phone])
    );

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildDatalist(id, values) {
      // cria/atualiza um datalist no DOM
      let dl = $(id);
      if (!dl) {
        dl = document.createElement("datalist");
        dl.id = id;
        document.body.appendChild(dl);
      }
      dl.innerHTML = values.map(v => `<option value="${escapeHtml(v)}"></option>`).join("");
    }

    function groupClass(group) {
      if (group === "full") return "form-group full";
      if (group === "three") return "form-group three-col";
      return "form-group"; // two (default)
    }

    function renderField(field) {
      const {
        id, label, type, placeholder, value, readonly, inputmode, step,
        listId, listFrom, options, optionsFrom, name
      } = field;

      const safeLabel = escapeHtml(label || "");
      const safeId = escapeHtml(id || "");
      const ro = readonly ? "readonly" : "";
      const im = inputmode ? `inputmode="${escapeHtml(inputmode)}"` : "";
      const st = step ? `step="${escapeHtml(step)}"` : "";
      const ph = placeholder ? `placeholder="${escapeHtml(placeholder)}"` : "";
      const val = (value !== undefined && value !== null) ? `value="${escapeHtml(value)}"` : "";

      if (type === "textarea") {
        return `
          <div>
            <label for="${safeId}">${safeLabel}</label>
            <textarea id="${safeId}" ${ph} ${ro}>${escapeHtml(value ?? "")}</textarea>
          </div>
        `;
      }

      if (type === "select") {
        const opts = optionsFrom
          ? (optionsFrom === "types"
              ? SCHEMA.types.map(t => ({ value: t.id, text: t.label }))
              : (SCHEMA.lists[optionsFrom] || []).map(v => ({ value: v, text: v }))
            )
          : (options || []).map(v => ({ value: v, text: v }));

        const first = (id === "carimbo_tipo")
          ? `<option value="">-- Selecione --</option>`
          : `<option value="" disabled selected>Selecione</option>`;

        return `
          <div>
            <label for="${safeId}">${safeLabel}</label>
            <select id="${safeId}">
              ${first}
              ${opts.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.text)}</option>`).join("")}
            </select>
          </div>
        `;
      }

      if (type === "radio") {
        const radioName = name || id;
        const opts = (options || []);
        return `
          <div>
            <label>${safeLabel}</label>
            <div class="checkbox-group">
              ${opts.map(opt => {
                const v = escapeHtml(opt);
                return `<label><input type="radio" name="${escapeHtml(radioName)}" value="${v}"> ${v}</label>`;
              }).join("")}
            </div>
          </div>
        `;
      }

      if (type === "datalist") {
        // garante datalist populado
        const values = (listFrom === "supervisors")
          ? SCHEMA.lists.supervisors.map(s => s.name)
          : (SCHEMA.lists[listFrom] || []);
        buildDatalist(listId, values);

        return `
          <div>
            <label for="${safeId}">${safeLabel}</label>
            <input type="text" id="${safeId}" list="${escapeHtml(listId)}" ${ph} ${val} ${ro} />
          </div>
        `;
      }

      // input gen√©rico
      const inputType = escapeHtml(type || "text");
      return `
        <div>
          <label for="${safeId}">${safeLabel}</label>
          <input type="${inputType}" id="${safeId}" ${ph} ${val} ${ro} ${im} ${st} />
        </div>
      `;
    }

    function renderForm(fields) {
      // agrupa por "group" para montar linhas
      const rows = [];
      let buffer = [];

      function flush(group) {
        if (!buffer.length) return;
        rows.push(`<div class="${groupClass(group)}">${buffer.join("")}</div>`);
        buffer = [];
      }

      let currentGroup = null;

      for (const f of fields) {
        const g = f.group || "two";
        if (currentGroup === null) currentGroup = g;
        if (g !== currentGroup) {
          flush(currentGroup);
          currentGroup = g;
        }
        buffer.push(renderField(f));
      }
      flush(currentGroup);

      return rows.join("");
    }

    function getCheckedValue(name) {
      return document.querySelector(`input[name="${CSS.escape(name)}"]:checked`)?.value || "";
    }

    function getValueById(id) {
      const el = $(id);
      if (!el) return "";
      if (el.tagName === "SELECT") return el.value || "";
      return (el.value ?? "").toString();
    }

    function collectData(typeDef) {
      const data = {};
      // base
      for (const f of SCHEMA.baseFields) {
        if (f.type === "radio") data[f.id] = getCheckedValue(f.name || f.id);
        else data[f.id] = getValueById(f.id).trim?.() ?? getValueById(f.id);
      }
      // tipo espec√≠fico
      for (const f of (typeDef?.fields || [])) {
        if (f.type === "radio") data[f.id] = getCheckedValue(f.name || f.id);
        else data[f.id] = getValueById(f.id).trim?.() ?? getValueById(f.id);
      }
      return data;
    }

    function hideOutput() {
      $("output").classList.remove("active");
      $("outputText").textContent = "";
      $("successMessage").classList.remove("show");
    }

    function showOutput(text) {
      $("outputText").textContent = text;
      $("output").classList.add("active");
      $("output").scrollIntoView({ behavior: "smooth" });
    }

    function clearTypeFields(typeDef) {
      if (!typeDef) return;
      for (const f of typeDef.fields) {
        const ro = !!f.readonly;
        if (ro) continue;

        if (f.type === "radio") {
          const nm = f.name || f.id;
          document.querySelectorAll(`input[name="${CSS.escape(nm)}"]`).forEach(r => r.checked = false);
          continue;
        }

        const el = $(f.id);
        if (!el) continue;
        if (el.tagName === "SELECT") el.selectedIndex = 0;
        else el.value = "";
      }
      hideOutput();
    }

    function renderDynamic(typeId) {
      const root = $("dynamicRoot");
      root.innerHTML = "";

      if (!typeId) {
        root.innerHTML = `
          <div class="section">
            <div class="hint">Selecione um tipo de carimbo acima para ver os campos espec√≠ficos.</div>
          </div>
        `;
        hideOutput();
        return;
      }

      const typeDef = SCHEMA.types.find(t => t.id === typeId);
      if (!typeDef) return;

      root.innerHTML = `
        <div class="section">
          <div class="section-title">${escapeHtml(typeDef.title)}</div>
          ${renderForm(typeDef.fields)}
          <div class="actions">
            <button class="btn-generate" id="btnGenerate" type="button">Gerar Carimbo</button>
            <button class="btn-clear" id="btnClear" type="button">Limpar Formul√°rio</button>
          </div>
        </div>
      `;

      $("btnGenerate").addEventListener("click", () => {
        const data = collectData(typeDef);
        const text = typeDef.stamp(data).join("\n").trim();
        showOutput(text);
      });

      $("btnClear").addEventListener("click", () => clearTypeFields(typeDef));
    }

    async function copyToClipboard() {
      const text = $("outputText").textContent || "";
      if (!text.trim()) return alert("Nenhum carimbo gerado. Gere o carimbo primeiro.");
      try {
        await navigator.clipboard.writeText(text);
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
      }
      $("successMessage").classList.add("show");
      setTimeout(() => $("successMessage").classList.remove("show"), 3000);
    }

    function sendToWhatsApp() {
      const text = $("outputText").textContent || "";
      if (!text.trim()) return alert("Nenhum carimbo gerado. Gere o carimbo primeiro.");
      window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
    }

    function initBase() {
      // garante datalists base
      buildDatalist("supervisorList", SCHEMA.lists.supervisors.map(s => s.name));
      buildDatalist("analistaList", SCHEMA.lists.analysts);
      buildDatalist("siteList", SCHEMA.lists.sites);

      // render base form
      $("baseForm").innerHTML = renderForm(SCHEMA.baseFields);

      // bind: troca de tipo
      $("carimbo_tipo").addEventListener("change", (e) => renderDynamic(e.target.value));

      // bind: autopreencher telefone supervisor
      $("supervisor").addEventListener("input", function() {
        const tel = supervisorPhones[normalizeName(this.value)];
        $("supervisor_tel").value = tel ?? "";
      });

      // binds output
      $("btnCopy").addEventListener("click", copyToClipboard);
      $("btnWhats").addEventListener("click", sendToWhatsApp);

      // estado inicial
      renderDynamic($("carimbo_tipo").value);
    }

    document.addEventListener("DOMContentLoaded", initBase);
  </script>
</body>
</html>

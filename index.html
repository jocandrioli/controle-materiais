<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerador de Carimbo - Acionamento GPON</title>
  <style>
/* Endere√ßo: mant√©m s√≥ o wrapper para o bot√£o "Buscar no mapa" (sem autocomplete) */
.suggest-box{ position:relative; }

:root{--primary:#003366;--primary-2:#004d99;--accent:#ff6600;--info:#0066cc;--bg:#f5f5f5;--panel:#fafafa;--text:#333;--muted:#666;--border:#ddd;--border-2:#999;--radius:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:var(--bg);padding:20px;line-height:1.6;color:var(--text)}
.container{max-width:1000px;margin:0 auto;background:#fff;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.1);overflow:hidden}
.header{background:var(--primary);color:#fff;padding:20px;text-align:center}
.header h1{font-size:24px;margin-bottom:5px}
.header p{font-size:12px;opacity:.9}
.header-section{background:#f9f9f9;padding:20px;border-bottom:2px solid var(--primary-2)}
.header-section h2{color:var(--primary);font-size:16px;margin-bottom:15px}
.section{margin-bottom:20px;padding:15px;border:1px solid var(--border);border-radius:4px;background:var(--panel)}
.section-title{font-weight:700;color:var(--primary);margin-bottom:12px;font-size:14px;border-bottom:2px solid var(--accent);padding-bottom:8px}
.dynamic-content{padding:20px}
.dynamic-content .hint{color:var(--muted);text-align:center;padding:40px 20px}
.form-group{margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group.full{grid-template-columns:1fr}
.form-group.three-col{grid-template-columns:1fr 1fr 1fr}
label{display:block;font-size:12px;font-weight:700;margin-bottom:4px}
input[type="text"],input[type="tel"],input[type="number"],input[type="time"],textarea,select{width:100%;padding:8px;border:1px solid var(--border-2);border-radius:4px;font-size:12px;font-family:Arial,sans-serif}
textarea{resize:vertical;min-height:60px}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);background:#fffef0}
.checkbox-group{display:flex;gap:15px;margin-top:8px;flex-wrap:wrap}
.checkbox-group label{display:inline-flex;align-items:center;margin-bottom:0;font-weight:600}
.checkbox-group input{width:auto;margin-right:6px}
.actions{display:flex;gap:10px;margin-top:20px;justify-content:space-between;flex-wrap:wrap}
button{padding:10px 20px;font-size:12px;border:0;border-radius:4px;cursor:pointer;font-weight:700;transition:.3s}
.btn-generate{background:var(--accent);color:#fff;flex:1;min-width:160px}
.btn-generate:hover{background:#e55a00}
.btn-clear{background:#999;color:#fff;flex:1;min-width:160px}
.btn-clear:hover{background:#777}
.btn-copy{background:var(--info);color:#fff;flex:1;min-width:160px}
.btn-copy:hover{background:#0052a3}
.output-section{margin:20px;padding:15px;background:#f0f0f0;border:1px solid var(--border);border-radius:4px;display:none}
.output-section.active{display:block}
.output-section h3{color:var(--primary);margin-bottom:10px;font-size:14px}
.output-text{background:#fff;padding:12px;border:1px solid var(--border-2);border-radius:4px;font-family:"Courier New",monospace;font-size:11px;line-height:1.6;max-height:300px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.success-message{background:#d4edda;color:#155724;padding:10px;border-radius:4px;margin-top:10px;font-size:12px;display:none}
.success-message.show{display:block}
.mini{font-size:11px;color:var(--muted)}
.tags-wrap{border:1px solid var(--border-2);border-radius:4px;padding:6px;background:#fff}
.tags-row{display:flex;gap:8px;align-items:center}
.tags-row input{border:1px solid var(--border);flex:1}
.tags-row .btn-add{padding:8px 10px;flex:0;background:var(--info)}

.materials-wrap{border:1px solid var(--border-2);border-radius:4px;padding:10px;background:#fff}
.materials-list{margin-bottom:12px;max-height:250px;overflow-y:auto}
.materials-list table{width:100%;border-collapse:collapse;font-size:12px}
.materials-list table th,.materials-list table td{border:1px solid var(--border);padding:6px;text-align:left}
.materials-list table th{background:#f0f0f0;font-weight:700}
.materials-add{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.materials-add select,.materials-add input{padding:8px;border:1px solid var(--border-2);border-radius:4px;font-size:12px}
.materials-add select{flex:1;min-width:200px}
.materials-add input[type="number"]{width:80px}
.materials-empty{color:var(--muted);padding:8px 0;font-size:12px}

/* Tabela de t√©cnicos */
.tech-table { margin-top: 10px; }
.tech-table table { width: 100%; border-collapse: collapse; font-size: 12px; }
.tech-table th, .tech-table td { border: 1px solid var(--border); padding: 6px; text-align: left; }
.tech-table th { background: #f0f0f0; font-weight: 700; }
.tech-table .btn-x { background: transparent; border: none; cursor: pointer; color: var(--accent); font-weight: 700; }
.tech-table .muted { color: var(--muted); font-size: 12px; padding: 6px 0; }

@media (max-width:768px){.form-group{grid-template-columns:1fr}.form-group.three-col{grid-template-columns:1fr}.actions{flex-direction:column}button{width:100%}.tags-row{flex-direction:column;align-items:stretch}.tags-row .btn-add{width:100%}.materials-add{flex-direction:column;align-items:stretch}.materials-add select,.materials-add input{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Gerador de Carimbo - RS-CAPITAL</h1>
      <p>Sistema de Acionamento - GPON - Vivo Rede</p>
    </div>
    <div class="header-section">
      <h2>Dados Gerais (Preenchidos para todos os carimbos)</h2>
      <div id="baseForm"></div>
      <div class="mini">* Campos espec√≠ficos aparecem ap√≥s selecionar o tipo de carimbo.</div>
    </div>
    <div class="dynamic-content">
      <div id="dynamicRoot"></div>
    </div>
    <div id="output" class="output-section">
      <h3>Carimbo de Texto Gerado</h3>
      <div class="output-text" id="outputText"></div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn-copy" id="btnCopy" type="button">Copiar para √Årea de Transfer√™ncia</button>
        <button class="btn-copy" id="btnWhats" type="button" style="background:#25d366;">Enviar via WhatsApp</button>
      </div>
      <div class="success-message" id="successMessage">Texto copiado para a √°rea de transfer√™ncia!</div>
    </div>
  </div>

  <script>
const SCHEMA = {
  app: { title: "Gerador de Carimbo - RS-CAPITAL", subtitle: "Sistema de Acionamento - GPON - Vivo Rede" },
  lists: {
    supervisors: [
      { name: "Alexandre Ilha", phone: "(51) 99753-4576" },
      { name: "Diego Jaworski", phone: "(51) 99670-7110" },
      { name: "Diego Richter", phone: "(51) 99754-9214" },
      { name: "Marcio Mendes", phone: "(51) 99589-2075" },
      { name: "M√°rio Pereira", phone: "(51) 99837-8234" },
      { name: "Rodrigo Duarte", phone: "(51) 99758-7793" },
      { name: "Rodrigo Rosa", phone: "(51) 99840-6074" }
    ],

    analysts: ["Carina F. Chuquel","Edmilson G. Rieira","Eduarda P. Rodrigues","Julia S. Silva","Matheus A. Castro","Rafaela V. Dias","Silvio L. R. Putrique"],

    techDirectory: [
      { phone:"51 99763-8035", matricula:"00076213", name:"Matheus S. Sanguine" },
      { phone:"51 99924-4755", matricula:"00163361", name:"Luciano Mabilia" },
      { phone:"51 99678-8025", matricula:"00163721", name:"Ismael S. Brito" },
      { phone:"51 99422-8248", matricula:"00060280", name:"Valdir R. C. Almeida" },
      { phone:"51 98030-9631", matricula:"00073519", name:"Silvio L. R. Putrique" },
      { phone:"51 99534-1867", matricula:"03540223", name:"Jos√© H. O. Machado" },
      { phone:"51 98054-0410", matricula:"00163877", name:"Guilherme D. S. Freitas" },
      { phone:"51 99526-0602", matricula:"00159101", name:"Lucas D. P. Cordeiro" },
      { phone:"51 99709-0842", matricula:"00163697", name:"Robson R. Silva" },
      { phone:"51 99618-2075", matricula:"00060276", name:"Laerte R. Silva" },
      { phone:"51 99763-4557", matricula:"00075430", name:"Marcio A. G. S. Santos" },
      { phone:"51 98064-4219", matricula:"00163623", name:"Luis C. S. Santos" },
      { phone:"51 98658-5845", matricula:"00161608", name:"Ronaldo F. Dutra" },
      { phone:"51 99612-4572", matricula:"03538188", name:"Marco A. Espindula" },
      { phone:"51 98200-2880", matricula:"00161750", name:"Neivo J. Rosa" },
      { phone:"51 99747-3044", matricula:"00163141", name:"Luis G. V. Ramos" },
      { phone:"51 98457-3078", matricula:"00161587", name:"Carlos D. R. S. Silva" },
      { phone:"51 98059-7226", matricula:"00163233", name:"Alex G. Matzenbacher" },
      { phone:"51 98023-8657", matricula:"03552249", name:"Carlos A. Souza" },
      { phone:"51 99570-4213", matricula:"03550117", name:"Cassiano R. A. S. Silva" },
      { phone:"51 99919-9314", matricula:"00164406", name:"Jair S. Correia" },
      { phone:"51 99764-5055", matricula:"00069814", name:"Sergio Klug" },
      { phone:"51 98041-7960", matricula:"00163287", name:"Pablo J. Rosa" },
      { phone:"51 98053-8983", matricula:"03538781", name:"Rafael B. Marco" },
      { phone:"51 99871-5081", matricula:"03538393", name:"Nairo I. Mirandoli" },
      { phone:"51 98098-6616", matricula:"00163683", name:"Diego M. Flores" },
      { phone:"51 99150-5863", matricula:"00161589", name:"Alexandre M. F. S. Santos" },
      { phone:"51 99597-6730", matricula:"00075370", name:"Atilas P. Carvalho" },
      { phone:"51 99231-4424", matricula:"00176139", name:"Antonio C. V. Callegari" },
      { phone:"51 99796-5508", matricula:"00176016", name:"Jo√£o C. C. Marques" },
      { phone:"51 99516-6051", matricula:"00176136", name:"Jonatan G. Santos" },
      { phone:"51 99628-3036", matricula:"00176067", name:"Lindomar A. Nascimento" },
      { phone:"51 98050-2082", matricula:"00176104", name:"Marcelo D. S. Teixeira" },
      { phone:"51 99774-0215", matricula:"00176008", name:"Miguel A. F. S. M. Machado" },
      { phone:"51 99859-9693", matricula:"00176073", name:"Uilian D. S. Salgado" },
      { phone:"51 99743-3673", matricula:"00176312", name:"Anderson T. C. Costa" },
      { phone:"51 99528-9884", matricula:"00176299", name:"Gabriel A. Ziemer" },
      /*{ phone:"51 99514-2776", matricula:"00176261", name:"Maicon S. Amorim" },*/
      { phone:"51 99648-3321", matricula:"00176277", name:"Sergio C. S. M. Junior" },
      { phone:"51 99897-8292", matricula:"00176115", name:"Vinicius D. S. Camponogara" }
    ],

    technicians: ["placeholder"],

    sites: ["RSCBM_G1N01","RSCBM_O1A01","RSGUB_G1N01","RSNHO_G1I02","RSPAE_G1B95","RSPAE_G1C01","RSPAE_G1I22","RSPAE_G1I23","RSPAE_G1I24","RSPAE_G1I25","RSPAE_G1I26","RSPAE_G1I32","RSPAE_G1I33","RSPAE_G1I35","RSPAE_G1I41","RSPAE_G1I47","RSPAE_G1I48","RSPAE_G1I51","RSPAE_G1I55","RSPAE_G1I57","RSPAE_G1N42","RSPAE_G1N45","RSSLE_G1M01","RSSLE_O1A04"],
    causes: ["Abalroamento","Furto","Acidente","Descarga","Vandalismo","Troca de poste","Degrada√ß√£o / Infiltra√ß√£o","Defeito","Falha em atividade anterior","Obra de terceiros","Interperie","Ataque de animais","Sem defeito pra rede"],
    materials: [
      {id:"mat_0001",name:"AL√áA PREFORM P/ DROP √ìPT ASU AT√â 12 FO",code:"0056-0003-0",unit:"un"},
      {id:"mat_0002",name:"SPLITTER OPT. PASSIVO 1:8-10 DB-FTTH",code:"0192-0219-9",unit:"un"},
      {id:"mat_0003",name:"KIT DERIV FIST-GCO DERIVA√á√ÉO RAYCHEM",code:"0219-0022-1",unit:"un"},
      {id:"mat_0004",name:"ABRA√á. A√áO INOX AUTO TRAVANTE S/PROT",code:"0219-0333-7",unit:"un"},
      {id:"mat_0005",name:"LA√áO PR√â-FORMADO LPF 4,8",code:"0256-0092-3",unit:"un"},
      {id:"mat_0006",name:"DERIVA√á√ÉO T PR√â-FORMADA P/CORDOALHA 6,4",code:"0256-0180-6",unit:"un"},
      {id:"mat_0007",name:"LA√áO PREFORM P/ DROP √ìPT ASU AT√â 12 FO",code:"0256-0234-9",unit:"un"},
      {id:"mat_0008",name:"AL√áA PREF P/CFOA-SM-AS-80 de 18 a 36 fo",code:"0256-0243-5",unit:"un"},
      {id:"mat_0009",name:"AL√áA PREF P/CFOA-SM-AS-80 de 48 a 72 fo",code:"0256-0244-6",unit:"un"},
      {id:"mat_0010",name:"AL√áA PREF. P/ CORDOALHA DIEL√âTRICA 6,4",code:"0380-9200-0",unit:"un"},
      {id:"mat_0011",name:"CORDOALHA DIEL√âTRICA 6,4",code:"0380-9201-1",unit:"m"},
      {id:"mat_0012",name:"DERIVACAO PREF P CORD DIELETRICA 6,4",code:"0380-9202-2",unit:"un"},
      {id:"mat_0013",name:"FIO DE ESPINAR DIELETRICO",code:"0380-9203-3",unit:"m"},
      {id:"mat_0014",name:"LA√áO PREF. P/ CORDOALHA DIEL√âTRICA 6,4",code:"0380-9204-4",unit:"un"},
      {id:"mat_0015",name:"CABO CFOA-SM AS 80 24F TS",code:"0452-0120-3",unit:"m"},
      {id:"mat_0016",name:"KIT DERIV TERMOC CEO AEREO/SUBT FOSC100",code:"0460-0048-2",unit:"un"},
      {id:"mat_0017",name:"CAIXA OPTICA 6 ADAPTADORES + PIGTAIL",code:"0486-0358-5",unit:"un"},
      {id:"mat_0018",name:"CRUZETA P RESERVA T√âCNICA FO POSTE 300mm",code:"0254-0061-4",unit:"un"},
      {id:"mat_0019",name:"SUP ANCORAGEM CABO OPT AS E CORD DIELETR",code:"0456-0157-7",unit:"un"},
      {id:"mat_0020",name:"SUP PASSAGEM CABO OPT AS E CORD DIELETR",code:"0456-0158-8",unit:"un"},
      {id:"mat_0021",name:"LA√áO PREF P/CFOA-SM-AS-80 DE 18 A 36 FO",code:"0456-0160-0",unit:"un"},
      {id:"mat_0022",name:"LA√áO PREF P/CFOA-SM-AS-80 DE 48 A 72 FO",code:"0456-0161-1",unit:"un"},
      {id:"mat_0023",name:"LA√áO PREF P/CFOA-SM-AS-80 DE 144 FO",code:"0456-0162-2",unit:"un"},
      {id:"mat_0024",name:"CTOPS 70/30 (AZUL) OPT",code:"0380-9207-7",unit:"un"},
      {id:"mat_0025",name:"CTOPS 80/20 (BRANCA) FC",code:"0380-9213-3",unit:"un"},
      {id:"mat_0026",name:"CTOPS 90/10 (VERDE) FC",code:"0380-9215-5",unit:"un"},
      {id:"mat_0027",name:"CTOPS 85/15 (AMARELA) FC",code:"0380-9214-4",unit:"un"},
      {id:"mat_0028",name:"CTOPS 1:8 (ROXA) FC",code:"0256-0343-3",unit:"un"},
      {id:"mat_0029",name:"CTOPS 60/40 (VERMELHA) FC",code:"0380-9211-1",unit:"un"},
      {id:"mat_0030",name:"CTOPS 70/30 (AZUL) FC",code:"0380-9212-2",unit:"un"},
      {id:"mat_0031",name:"MINI CDOE 1:8 ENTRADA E SA√çDA PRECON",code:"0186-0100-2",unit:"un"},
      {id:"mat_0032",name:"MINI CDOE 85/15",code:"0186-0099-8",unit:"un"},
      {id:"mat_0033",name:"MINI CDOE 80/20",code:"0186-0099-9",unit:"un"},
      {id:"mat_0034",name:"MINI CDOE 90/10",code:"0186-0100-0",unit:"un"},
      {id:"mat_0035",name:"MINI CDOE 60/40",code:"0186-0097-7",unit:"un"},
      {id:"mat_0036",name:"MINI CDOE 70/30",code:"0186-0098-8",unit:"un"},
      {id:"mat_0037",name:"BRA√áADEIRA REGUL√ÅVEL POSTE BAP-3",code:"0256-0073-7",unit:"un"},
      {id:"mat_0038",name:"ANEL DE DISTRIBUICAO EM ACO AGFS",code:"0230-0204-7",unit:"un"},
      {id:"mat_0039",name:"BRA√áADEIRA REGUL√ÅVEL POSTE BAP-2",code:"0256-0072-9",unit:"un"},
      {id:"mat_0040",name:"AL√áA PLASTICA PARA ANCORAGEM CFOA 5MM",code:"0380-9220-0",unit:"un"},
      {id:"mat_0041",name:"SUPORTE UNIVERSAL PARA CAIXA BARRAMENTO",code:"0460-0069-9",unit:"un"},
      {id:"mat_0042",name:"PLAQUETA DE IDENTIFICA√á√ÉO PARA CABO √ìPTI",code:"0840-2667-7",unit:"un"},
      {id:"mat_0043",name:"CARACTER ADESIVO 15MM ALGARISMOS 0-9",code:"9001-1358-8",unit:"plc"},
      {id:"mat_0044",name:"CARACTER ADESIVO 15MM ALFABETO A-N",code:"9001-1360-0",unit:"plc"},
      {id:"mat_0045",name:"CHAPA MEIO DE VAO",code:"0230-0232-5",unit:"un"},
      {id:"mat_0046",name:"DROP OPTICO AS CM AR FIG8 LSZH 4F",code:"0380-9221-1",unit:"m"},
      {id:"mat_0047",name:"CABO DROP CIRCULAR 5 MM 12F",code:"0452-1257-7",unit:"m"},
      {id:"mat_0048",name:"MINI-CEO TERMOC 16ENT AEREO E SUBT 144FO",code:"0456-0170-0",unit:"un"},
      {id:"mat_0049",name:"CONJ EMENDA 48F 4ENT",code:"0456-0169-9",unit:"un"},
      {id:"mat_0050",name:"CONJ EMENDA 72F 4ENT",code:"0456-0172-2",unit:"un"},
      {id:"mat_0051",name:"CABO DROP CIRCULAR 12F - 100M",code:"0452-1258-8",unit:"un"},
      {id:"mat_0052",name:"CABO DROP CIRCULAR 12F - 500M",code:"0452-1264-4",unit:"un"},
      {id:"mat_0053",name:"CABO DROP CIRCULAR 12F - 150M",code:"0452-1259-9",unit:"un"},
      {id:"mat_0054",name:"CABO DROP CIRCULAR 12F - 200M",code:"0452-1260-0",unit:"un"},
      {id:"mat_0055",name:"CABO DROP CIRCULAR 12F - 250M",code:"0452-1261-1",unit:"un"},
      {id:"mat_0056",name:"CABO DROP CIRCULAR 12F - 300M",code:"0452-1262-2",unit:"un"},
      {id:"mat_0057",name:"CABO DROP CIRCULAR 12F - 400M",code:"0452-1263-3",unit:"un"},
      {id:"mat_0058",name:"CABO DROP CIRCULAR 24F - 100M",code:"0452-1280-0",unit:"un"},
      {id:"mat_0059",name:"AL√áA PLASTIC ATE 6,3MM C/GANCHO METALICO",code:"0380-9242-2",unit:"un"},
      {id:"mat_0060",name:"CEOP 12F",code:"0456-0184-4",unit:"un"},
      {id:"mat_0061",name:"CDPS 2 SP1:8 CAIXA DERIV PRE-C SPLIT",code:"0460-0072-2",unit:"un"},
      {id:"mat_0062",name:"CDPS SP1:8 CAIXA DERIV PRE-C SPLIT",code:"0460-0074-4",unit:"un"},
      {id:"mat_0063",name:"CDPS SP1:4 CAIXA DERIV PRE-C SPLIT",code:"0460-0080-0",unit:"un"},
      {id:"mat_0064",name:"CDPS 4 SP1:4 CAIXA DERIV PRE-C SPLIT",code:"0460-0078-8",unit:"un"},
      {id:"mat_0065",name:"CDPS 2 SP1:4 CAIXA DERIV PRE-C SPLIT",code:"0460-0079-9",unit:"un"},
      {id:"mat_0066",name:"CONJ. SUP. CABOS OPT MEIO DE VAO RAQUETE",code:"0460-0084-4",unit:"un"},
      {id:"mat_0072",name:"FITA PARA ROTULADORA ELETRONICA (PT80)",code:"0378-1565-0",unit:"rolo"},
      {id:"mat_0073",name:"ADAPTADOR REF UNIV DROP FIG8",code:"0380-9259-9",unit:"un"},
      {id:"mat_0074",name:"FIO DE ESPINAR ISOLADO PARA AGRUPADOR",code:"0380-9291-0",unit:"m"},
      {id:"mat_0075",name:"LA√áO PREF P/ CABO DROP ALT. CAP ATE 48",code:"0380-9294-0",unit:"un"},
      {id:"mat_0076",name:"AL√áA PREF P/ CABO DROP ALT. CAP ATE 48",code:"0380-9295-0",unit:"un"},
      {id:"mat_0077",name:"CUNHA PL√ÅST P/ DROP √ìPT ROC/FIG8 REDEXT",code:"0099-0119-0",unit:"un"},
      {id:"mat_0078",name:"CONECT OPT FAC SC/APC FIG8 COMPAC REDEXT",code:"0380-9292-0",unit:"un"},
      {id:"mat_0079",name:"DROP OPT COMP INTERNO CFOI REDEXT",code:"0380-9293-0",unit:"un"},
      {id:"mat_0080",name:"PONTO TERMINAL DE REDE-√ìPTICO REDEXT",code:"0258-0397-0",unit:"un"},
      {id:"mat_0081",name:"TUBO ISOLADOR MENSAGEIRO TIM 4,8MM",code:"0430-0018-0",unit:"m"},
      {id:"mat_0082",name:"TUBO ISOLADOR MENSAGEIRO TIM 6,4MM",code:"0430-0019-0",unit:"m"},
      {id:"mat_0083",name:"AL√áA PREF DROP FIG8",code:"0380-9296-0",unit:"un"},
      {id:"mat_0084",name:"LA√áO PREF DROP FIG8",code:"0380-9297-0",unit:"un"},
      {id:"mat_0085",name:"SUP ENCAIXE UNIFICADO 04 ROLD (TIPO DM)",code:"0456-0201-0",unit:"un"},
      {id:"mat_0086",name:"SPIRAL TUBE 1/2 LARANJA",code:"0254-0082-7",unit:"m"},
      {id:"mat_0087",name:"DUTO P PROTE√á√ÉO PARA CABOS EM REDE AEREA",code:"0430-0017-7",unit:"m"},
      {id:"mat_0088",name:"CABO DROP ALTA CAPACID. 24F S/MPO",code:"0452-1331-0",unit:"m"},
      {id:"mat_0089",name:"CABO DROP ALTA CAPACID. 36F S/MPO",code:"0452-1332-0",unit:"m"},
      {id:"mat_0090",name:"CABO DROP ALTA CAPACID. 144F S/MPO",code:"0452-1373-0",unit:"m"},
      {id:"mat_0091",name:"Protetor Ref p/ Conec Campo CDOE (NOVA)",code:"0458-0014-0",unit:"un"},
      {id:"mat_0092",name:"CABO DROP ALTA CAPACID. 72 FIBRAS S/MPO",code:"0452-1333-0",unit:"m"},
      {id:"mat_0093",name:"Protetor p/ Conec Refor√ßado de Campo",code:"0458-0015-0",unit:"un"},
      {id:"mat_0094",name:"AL√áA PREF P/ CABO DROP ALT. CAP. 72FO",code:"0256-0367-0",unit:"un"},
      {id:"mat_0095",name:"AL√áA PREF P/ CABO DROP ALT. CAP 144FO",code:"0256-0368-0",unit:"un"},
      {id:"mat_0096",name:"PROTETOR EMENDA 45 mm X 3,5 m (Tubete)",code:"0458-0018-0",unit:"un"}
    ]
  },
  baseFields: [
    {id:"id_ocorrencia",label:"Ocorr√™ncia/Porta CTO (BA/TT)",type:"text",placeholder:"Ex: 123456",group:"two"},
    {id:"carimbo_tipo",label:"Selecione o Tipo de Carimbo",type:"select",optionsFrom:"types",group:"two"},
    {id:"supervisor",label:"Supervisor",type:"datalist",listId:"supervisorList",listFrom:"supervisors",placeholder:"Nome do Supervisor",group:"two"},
    {id:"supervisor_tel",label:"Telefone Supervisor",type:"hidden",placeholder:"(51) 9XXXX-XXXX",inputmode:"tel",group:"two"},
    {id:"tecnicos",label:"T√©cnicos(s)",type:"tags",listId:"tecnicoList",listFrom:"technicians",placeholder:"Comece a digitar para pesquisar",group:"two"},
    {id:"tecnico_tel",label:"Telefone T√©cnico",type:"hidden",placeholder:"(51) 9XXXX-XXXX",inputmode:"tel",group:"two"},
    {id:"analista_ccr",label:"Analista CCR",type:"datalist",listId:"analistaList",listFrom:"analysts",placeholder:"Digite para pesquisar ou selecione na lista",group:"full"}
  ],
  types: [
    {id:"acionamento",label:"1. Acionamento",title:"ACIONAMENTO",fields:[{id:"acionamento_prev_chegada",label:"Previs√£o de chegada ao SITE/ARO para medi√ß√µes",type:"time",group:"two"},{id:"acionamento_site",label:"Nome SITE/ARO para medi√ß√µes",type:"datalist",listId:"siteList",listFrom:"sites",placeholder:"Digite para pesquisar ou selecione na lista",group:"two"}],stamp:(d)=>["1 - ACIONAMENTO","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`Previs√£o de chegada ao SITE/ARO para medi√ß√µes: ${d.acionamento_prev_chegada}`,`Nome SITE/ARO para medi√ß√µes: ${d.acionamento_site}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"deslocamento",label:"2. Deslocamento ao Ponto da Falha",title:"DESLOCAMENTO AO PONTO DA FALHA",fields:[{id:"deslocamento_km",label:"KM at√© o LOCAL da falha",type:"number",step:"0.1",placeholder:"Ex: 15.5",group:"two"},{id:"deslocamento_prev_chegada",label:"Previs√£o de chegada ao LOCAL da falha",type:"time",group:"two"},{id:"deslocamento_obs",label:"Observa√ß√µes",type:"textarea",placeholder:"Observa√ß√µes sobre o deslocamento",group:"full"}],stamp:(d)=>["2 - DESLOCAMENTO AO PONTO DA FALHA","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`KM at√© o LOCAL da falha: ${d.deslocamento_km} km`,`Previs√£o de chegada ao LOCAL da falha: ${d.deslocamento_prev_chegada}`,`Obs.: ${d.deslocamento_obs}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"recuperacao",label:"3. Recupera√ß√£o da Falha",title:"RECUPERA√á√ÉO DA FALHA",fields:[{id:"recuperacao_causa",label:"Causa raiz",type:"select",optionsFrom:"causes",group:"two"},{id:"recuperacao_prev_testes",label:"Previs√£o para solicita√ß√£o de testes",type:"time",group:"two"},{id:"recuperacao_endereco",label:"Endere√ßo da falha",type:"text",placeholder:"Rua, N√∫mero, Complemento",group:"two"},{id:"recuperacao_cabo",label:"Cabo / Capacidade / ARO",type:"select",options:["Drop Fig8 4F","12F","24F","36F","48F","72F","144F","288F"],group:"two"},{id:"recuperacao_tratativas",label:"Tratativas realizadas",type:"textarea",placeholder:"Descreva as tratativas",group:"full"},{id:"recuperacao_obs",label:"Observa√ß√µes",type:"textarea",placeholder:"Observa√ß√µes gerais",group:"full"}],stamp:(d)=>["3 - RECUPERA√á√ÉO DA FALHA","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`Causa raiz: ${d.recuperacao_causa}`,`Previs√£o para solicita√ß√£o de testes: ${d.recuperacao_prev_testes}`,`Endere√ßo da falha: ${d.recuperacao_endereco}`,`Cabo/Capacidade/ARO: ${d.recuperacao_cabo}`,`Tratativas realizadas: ${d.recuperacao_tratativas}`,`Obs.: ${d.recuperacao_obs}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"certificacao",label:"4. Certifica√ß√£o",title:"SOLICITA√á√ÉO DE CERTIFICA√á√ÉO",fields:[
      {id:"certificacao_tratativa",label:"Tratativa realizada",type:"textarea",placeholder:"Descri√ß√£o da tratativa realizada",group:"full"},
      {id:"certificacao_causa",label:"Causa",type:"select",optionsFrom:"causes",group:"two"},
      {id:"certificacao_subcausa",label:"Subcausa",type:"subcause_dynamic",dependsOn:"certificacao_causa",group:"full"},
      {id:"certificacao_material",label:"Materiais Utilizados",type:"materials",group:"full"},
            {id:"certificacao_anexos",label:"Anexos (fotos/arquivos)",type:"file",accept:"image/*,application/pdf",multiple:true,help:"Selecione fotos/arquivos. No celular, use a c√¢mera se desejar.",group:"full"},
      {id:"certificacao_foto",label:"Foto em anexo",type:"radio",name:"certificacao_foto",options:["Sim","N√£o"],group:"full"}
    ],
    stamp:(d)=>{
      const materials = JSON.parse(d.certificacao_material || "[]");
      const materialLines = materials.length > 0
        ? ["Materiais utilizados:", ...materials.map(m => `  - ${m.name}: ${m.quantity} ${m.unit} (${m.code})`)]
        : ["Nenhum material registrado"];

const geoTxt = String(d.certificacao_geo || "indispon√≠vel");

// Divide em: "coords ¬±acc"  |  "data/hora"
const parts = geoTxt.split("|").map(s => s.trim());
const left = parts[0] || "";
const timePart = parts[1] || "";

// Extrai lat/long
const coordMatch = left.match(/(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/);
const latLong = coordMatch ? `${coordMatch[1]}, ${coordMatch[2]}` : "indispon√≠vel";

// Extrai acur√°cia (¬±Xm)
const accMatch = left.match(/¬±\s*(\d+(?:\.\d+)?)\s*m/i);
const accuracy = accMatch ? `¬±${accMatch[1]}m` : "indispon√≠vel";

return [
  "4 - SOLICITA√á√ÉO DE CERTIFICA√á√ÉO", "",
  `ID Ocorr√™ncia: ${d.id_ocorrencia}`,
  `Supervisor: ${d.supervisor}`,
  `Telefone: ${d.supervisor_tel}`,
  `T√©cnicos(s): ${d.tecnicos}`,
  `Telefone: ${d.tecnico_tel}`,
  `Tratativa realizada: ${d.certificacao_tratativa}`,  `Causa: ${d.certificacao_causa || getLastCause() || "indispon√≠vel"}`,
  ...(d.certificacao_subcausa ? [`Subcausa: ${d.certificacao_subcausa}`] : []),
  ...materialLines,
  `Foto em anexo: ${d.certificacao_foto}`,
  `Analista CCR: ${d.analista_ccr}`,

  // ‚úÖ Agora em campos separados
  `Lat./Long.: ${latLong}`,
  `Acur√°cia: ${accuracy}`,
  `Data/Hora: ${timePart || "indispon√≠vel"}`
];
    }
    },
    {id:"complementar",label:"Complementar",title:"COMPLEMENTAR",fields:[{id:"complementar_motivo",label:"Motivo",type:"text",placeholder:"Motivo da complementa√ß√£o",group:"two"},{id:"complementar_info",label:"Informa√ß√£o",type:"text",placeholder:"Informa√ß√£o adicional",group:"two"},{id:"nova_previsao",label:"Nova previs√£o?",type:"radio",name:"nova_previsao",options:["Sim","N√£o"],group:"two"},{id:"complementar_previsao",label:"Previs√£o",type:"time",group:"two"}],stamp:(d)=>["COMPLEMENTAR","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Motivo: ${d.complementar_motivo}`,`Informa√ß√£o: ${d.complementar_info}`,`Nova previs√£o? ${d.nova_previsao}`,`Previs√£o: ${d.complementar_previsao}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"naofalha",label:"N√£o h√° Falha para Rede",title:"N√ÉO H√Å FALHA PARA REDE",fields:[{id:"naofalha_motivo",label:"Motivo da Improdutiva",type:"textarea",placeholder:"Descreva o motivo da improdutiva",group:"full"},{id:"naofalha_foto",label:"Foto em anexo",type:"radio",name:"naofalha_foto",options:["Sim","N√£o"],group:"two"},{id:"naofalha_gestor",label:"Ciente (Gestor VIVO Rede)",type:"text",value:"Jo√£o Andrioli",readonly:true,group:"two"}],stamp:(d)=>["N√ÉO H√Å FALHA PARA REDE/ IMPROCED√äNCIA","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`Motivo da improdutiva: ${d.naofalha_motivo}`,`Foto em anexo: ${d.naofalha_foto}`,`Ciente (Gestor VIVO Rede): ${d.naofalha_gestor}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"transbordo",label:"Transbordo",title:"TRANSBORDO",fields:[{id:"transbordota",label:"TA",type:"text",placeholder:"TA",group:"two"},{id:"transbordocontrato",label:"CONTRATO",type:"text",placeholder:"Contrato",group:"two"},{id:"transbordooperadora",label:"TRANSBORDO",type:"text",value:"VIVO",readonly:true,group:"two"}],stamp:(d)=>["TRANSBORDO","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`TA: ${d.transbordota}`,`CONTRATO: ${d.transbordocontrato}`,`TRANSBORDO: ${d.transbordooperadora}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"prazo",label:"Prazo de Reparo",title:"PRAZO DE REPARO",fields:[{id:"prazoreparocargo",label:"Cargo",type:"text",value:"Coordenador",readonly:true,group:"two"},{id:"prazoreparonometel",label:"Nome / Telefone",type:"text",value:"Jo√£o Andrioli / 41 99244-9441",readonly:true,group:"two"},{id:"prazoreparosla",label:"SLA do evento",type:"text",placeholder:"Ex: 4h, 2h",group:"two"},{id:"prazoreparoobs",label:"Observa√ß√µes",type:"text",placeholder:"Observa√ß√µes",group:"two"}],stamp:(d)=>["ESCALONAMENTO PRAZO REPARO","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Supervisor: ${d.supervisor}`,`Telefone: ${d.supervisor_tel}`,`T√©cnicos(s): ${d.tecnicos}`,`Telefone: ${d.tecnico_tel}`,`Cargo: ${d.prazoreparocargo}`,`Nome/Tel.: ${d.prazoreparonometel}`,`SLA do evento: ${d.prazoreparosla}`,`Obs.: ${d.prazoreparoobs}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"cire",label:"CIRE",title:"INTERVEN√á√ÉO CIRE",fields:[{id:"cire_solicitante",label:"Solicitante",type:"text",placeholder:"Nome do Solicitante",group:"two"},{id:"cire_contato",label:"Meio de contato",type:"radio",name:"cire_contato",options:["Telefone","E-mail","WhatsApp"],group:"two"},{id:"cire_motivo",label:"Motivo",type:"textarea",placeholder:"Descreva o motivo da interven√ß√£o CIRE",group:"full"},{id:"cire_info",label:"Informa√ß√£o",type:"textarea",placeholder:"Informa√ß√µes adicionais",group:"full"},{id:"cire_previsao",label:"Previs√£o",type:"time",group:"two"}],stamp:(d)=>["INTERVEN√á√ÉO CIRE","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Solicitante: ${d.cire_solicitante}`,`Meio de contato: ${d.cire_contato}`,`Motivo: ${d.cire_motivo}`,`Informa√ß√£o: ${d.cire_info}`,`Previs√£o: ${d.cire_previsao}`,`Analista CCR: ${d.cire_analista || d.analista_ccr}`]},
    {id:"escalonamento",label:"Escalonamento sem Equipe",title:"ESCALONAMENTO SEM EQUIPE",fields:[{id:"escalonamento_cargo",label:"Cargo",type:"text",value:"Coordenador",readonly:true,group:"two"},{id:"escalonamento_nome_tel",label:"Nome / Telefone",type:"text",value:"Jo√£o Andrioli / 41 99244-9441",readonly:true,group:"two"},{id:"escalonamento_sla",label:"SLA do evento",type:"text",placeholder:"Ex: 4h, 2h",group:"two"},{id:"escalonamento_obs",label:"Observa√ß√µes",type:"text",placeholder:"Observa√ß√µes",group:"two"}],stamp:(d)=>["ESCALONAMENTO SEM EQUIPE","",`ID Ocorr√™ncia: ${d.id_ocorrencia}`,`Cargo: ${d.escalonamento_cargo}`,`Nome/Tel.: ${d.escalonamento_nome_tel}`,`SLA do evento: ${d.escalonamento_sla}`,`Obs.: ${d.escalonamento_obs}`,`Analista CCR: ${d.analista_ccr}`]},
    {id:"cto_defeito",label:"CTO com Defeito",title:"CTO COM DEFEITO",fields:[{id:"cto_defeito_site",label:"Nome SITE/ARO",type:"datalist",listId:"siteList",listFrom:"sites",placeholder:"Digite para pesquisar ou selecione na lista",group:"two"},{id:"cto_defeito_splitter",label:"Splitter",type:"text",placeholder:"Ex: SP001, SP144",group:"two"},{id:"cto_defeito_caixa",label:"Caixa",type:"text",placeholder:"Ex: G0001, G0099, GP0050",group:"two"},{id:"cto_defeito_endereco",label:"Endere√ßo",type:"text",placeholder:"Rua, N√∫mero, Complemento",group:"two"},{id:"cto_defeito_causa",label:"Causa",type:"select",optionsFrom:"causes",group:"two"},{id:"cto_defeito_tratativa",label:"Tratativa realizada",type:"textarea",placeholder:"Descreva a tratativa realizada",group:"full"},{id:"cto_defeito_material",label:"Materiais Utilizados",type:"materials",group:"full"}],

    stamp:(d)=>{
      const materials = JSON.parse(d.cto_defeito_material || "[]");
      const materialLines = materials.length > 0
        ? ["Materiais utilizados:", ...materials.map(m => `  - ${m.name}: ${m.quantity} ${m.unit} (${m.code})`)]
        : ["Nenhum material registrado"];

      return [
        "CTO COM DEFEITO", "",
        `OS BA/TT: ${d.id_ocorrencia}`,
        `Supervisor: ${d.supervisor}`,
        `Telefone: ${d.supervisor_tel}`,
        `T√©cnicos(s): ${d.tecnicos}`,
        `Telefone: ${d.tecnico_tel}`,
        `Nome SITE/ARO: ${d.cto_defeito_site}`,
        `Splitter: ${d.cto_defeito_splitter}`,
        `Caixa: ${d.cto_defeito_caixa}`,
        `Endere√ßo: ${d.cto_defeito_endereco}`,
        `Causa: ${d.cto_defeito_causa}`,
        `Tratativa realizada: ${d.cto_defeito_tratativa}`,
        ...materialLines,
        `Analista CCR: ${d.analista_ccr}`
      ];
    }

    }
  ]
};


// ====== SUBCAUSAS (Carimbo 4 usa a CAUSA do Carimbo 3 como sugest√£o) ======
const SUBCAUSES = {
  "Furto": ["Cabo", "CEO", "CTO", "Splitter"],
  "Acidente": ["Carga alta", "Linha de pipa"],
  "Descarga": ["Atmosferica", "Eletrica"],
  "Degrada√ß√£o / Infiltra√ß√£o": ["CEO", "CTO", "DGOI"],
  "Defeito": ["Splitter Atenuado", "Fibra curta", "Sa√≠da de Splitter", "Sem sinal"],
  "Falha em atividade anterior": ["Atenua√ß√£o", "Desorganiza√ß√£o", "Fibra invertida", "Fibra quebrada"],
  "Obra de terceiros": ["Outras obras", "Poda de Arvore", "Troca de poste n√£o programada"],
  "Ataque de animais": ["Abelha", "Formiga", "Outros", "Roedores"],
  "Sem defeito pra rede": ["Encontrado OK"]
};

// Persist√™ncia da CAUSA do Carimbo 3 (Recupera√ß√£o)
const LAST_CAUSE_KEY = "last_cause_carimbo3";
const setLastCause = (cause) => localStorage.setItem(LAST_CAUSE_KEY, (cause || "").trim());
const getLastCause = () => (localStorage.getItem(LAST_CAUSE_KEY) || "").trim();


// ====== MAPA DE CAMPOS OBRIGAT√ìRIOS (Observa√ß√µes REMOVIDAS) ======
const REQUIRED = {
  acionamento: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","acionamento_prev_chegada","acionamento_site"],
  deslocamento: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","deslocamento_km","deslocamento_prev_chegada"], // observa√ß√µes opcional
  recuperacao: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","recuperacao_causa","recuperacao_prev_testes","recuperacao_endereco","recuperacao_cabo","recuperacao_tratativas"], // observa√ß√µes opcional
  certificacao: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","certificacao_tratativa","certificacao_causa","certificacao_foto","certificacao_geo"], // geo exigido
  complementar: ["id_ocorrencia","complementar_motivo","complementar_info","nova_previsao","complementar_previsao"],
  naofalha: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","naofalha_motivo","naofalha_foto","naofalha_gestor"],
  transbordo: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","transbordota","transbordocontrato","transbordooperadora"],
  prazo: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","prazoreparocargo","prazoreparonometel","prazoreparosla"], // observa√ß√µes opcional
  cire: ["cire_solicitante","cire_contato","cire_motivo","cire_info","cire_previsao"],
  escalonamento: ["id_ocorrencia","escalonamento_cargo","escalonamento_nome_tel","escalonamento_sla"], // observa√ß√µes opcional
  cto_defeito: ["id_ocorrencia","supervisor","supervisor_tel","tecnicos","tecnico_tel","analista_ccr","cto_defeito_site","cto_defeito_splitter","cto_defeito_caixa","cto_defeito_endereco","cto_defeito_causa","cto_defeito_tratativa"]
};

// ‚úÖ Ordena√ß√£o alfab√©tica (ignorando acentos)
const sortPT = (a, b) => (a || "").localeCompare(b || "", "pt-BR", { sensitivity: "base" });

// Diret√≥rio -> datalist
if (Array.isArray(SCHEMA.lists.techDirectory) && SCHEMA.lists.techDirectory.length) {
  SCHEMA.lists.techDirectory = SCHEMA.lists.techDirectory.map(x => ({
    name: (x.name || "").trim(),
    phone: (x.phone || "").trim(),
    matricula: (x.matricula || "").trim()
  }));
  SCHEMA.lists.technicians = [...new Set(SCHEMA.lists.techDirectory.map(x => x.name))].sort(sortPT);
}

const $ = (id) => document.getElementById(id);
const normalizeName = (str) => (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();


// ====== STORE DE ARQUIVOS (anexos) ======
const FILE_STORE = Object.create(null);
function registerFileInput(fieldId){
  const el = document.getElementById(fieldId);
  if(!el) return;
  el.addEventListener('change', ()=>{ FILE_STORE[fieldId] = Array.from(el.files || []); });
}
function getFiles(fieldId){ return Array.from(FILE_STORE[fieldId] || []); }

// ====== ENFORCE: campos com lista devem ser escolhidos da lista ======
function getAllowedListForField(field){
  if(!field || field.type !== 'datalist') return [];
  const src = field.listFrom;
  if(!src) return [];
  if(src === 'supervisors') return (SCHEMA.lists.supervisors || []).map(s=>s.name);
  return (SCHEMA.lists[src] || []).slice();
}
function isValueInAllowed(value, allowed){
  const v = normalizeName(value);
  return allowed.some(a => normalizeName(a) === v);
}
function attachDatalistEnforcement(fields){
  (fields || []).filter(f=>f.type==='datalist').forEach(f=>{
    const el = document.getElementById(f.id);
    if(!el) return;
    const allowed = getAllowedListForField(f);
    const check = ()=>{
      const val = (el.value || '').trim();
      if(!val) return;
      if(allowed.length && !isValueInAllowed(val, allowed)){
        alert(`Selecione um valor da lista para: ${f.label || f.id}`);
        el.value = '';
        if(f.id === 'supervisor'){ const st = document.getElementById('supervisor_tel'); if(st) st.value = ''; }
      }
    };
    el.addEventListener('blur', check);
    el.addEventListener('change', check);
  });
}
const supervisorPhones = Object.fromEntries(SCHEMA.lists.supervisors.map(s => [normalizeName(s.name), s.phone]));

function formatPhoneBR(raw) {
  const digits = String(raw || "").replace(/\D/g, "");
  if (digits.length === 11) return `(${digits.slice(0,2)}) ${digits.slice(2,7)}-${digits.slice(7)}`;
  if (digits.length === 10) return `(${digits.slice(0,2)}) ${digits.slice(2,6)}-${digits.slice(6)}`;
  return raw || "";
}

// ‚úÖ Escape HTML
function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function linesToSafeHtml(lines) {
  return (lines || [])
    .map(line => escapeHtml(line).replace(/\n/g, "&lt;br&gt;"))
    .join("&lt;br&gt;\n")
    .trim();
}

function buildDatalist(id, values) {
  let dl = $(id);
  if (!dl) { dl = document.createElement("datalist"); dl.id = id; document.body.appendChild(dl); }
  // Coer√ß√£o para string: aceita arrays de strings ou objetos {name|text}
  const listValues = (values || []).map(v => {
    if (typeof v === "string") return v;
    if (v && typeof v === "object") return v.name || v.text || "";
    return String(v ?? "");
  });
  dl.innerHTML = listValues.map(v => `<option value="${escapeHtml(v)}"></option>`).join("");
}

function groupClass(group) { return group === "full" ? "form-group full" : group === "three" ? "form-group three-col" : "form-group"; }

function renderField(field) {
  const { id, label, type, placeholder, value, readonly, inputmode, step, listId, listFrom, options, optionsFrom, name, accept, multiple, capture, help } = field;
  const safeLabel = escapeHtml(label || ""), safeId = escapeHtml(id || ""), ro = readonly ? "readonly" : "", im = inputmode ? `inputmode="${escapeHtml(inputmode)}"` : "", st = step ? `step="${escapeHtml(step)}"` : "", ph = placeholder ? `placeholder="${escapeHtml(placeholder)}"` : "", val = (value !== undefined && value !== null) ? `value="${escapeHtml(value)}"` : "";

  if (type === "textarea") return `<div><label for="${safeId}">${safeLabel}</label><textarea id="${safeId}" ${ph} ${ro}>${escapeHtml(value ?? "")}</textarea></div>`;

if (type === "hidden") {
  // Campo invis√≠vel (usado para telefones auto-preenchidos)
  return `<div style="display:none"><input type="hidden" id="${safeId}" ${val} /></div>`;
}
if (type === "file") {
  const acc = accept ? `accept="${escapeHtml(accept)}"` : "";
  const mult = multiple ? "multiple" : "";
  const cap = capture ? `capture="${escapeHtml(capture)}"` : "";
  const hint = help ? `<div class="mini" style="margin-top:4px">${escapeHtml(help)}</div>` : "";
  return `<div><label for="${safeId}">${safeLabel}</label><input type="file" id="${safeId}" ${acc} ${mult} ${cap} /></div>${hint}`;
}

if (type === "select") {
    const opts = optionsFrom ? (optionsFrom === "types" ? SCHEMA.types.map(t => ({ value: t.id, text: t.label })) : (SCHEMA.lists[optionsFrom] || []).map(v => ({ value: v, text: v }))) : (options || []).map(v => ({ value: v, text: v }));
    const first = (id === "carimbo_tipo") ? `<option value="">-- Selecione --</option>` : `<option value="" disabled selected>Selecione</option>`;
    return `<div><label for="${safeId}">${safeLabel}</label><select id="${safeId}">${first}${opts.map(o => `<option value="${escapeHtml(o.value)}">${escapeHtml(o.text)}</option>`).join("")}</select></div>`;
  }
  if (type === "radio") {
    const radioName = name || id, opts = (options || []);
    return `<div><label>${safeLabel}</label><div class="checkbox-group">${opts.map(opt => {const v = escapeHtml(opt); return `<label><input type="radio" name="${escapeHtml(radioName)}" value="${v}"> ${v}</label>`}).join("")}</div></div>`;
  }
  if (type === "datalist") {
    const values = (SCHEMA.lists[listFrom] || []);
    buildDatalist(listId, values);
    return `<div><label for="${safeId}">${safeLabel}</label><input type="text" id="${safeId}" list="${escapeHtml(listId)}" ${ph} ${val} ${ro} /></div>`;
  }

  if (type === "tags") {
    const values = (SCHEMA.lists[listFrom] || []);
    buildDatalist(listId, values);
    return `
      <div>
        <label for="${safeId}_input">${safeLabel}</label>
        <div class="tags-wrap" id="${safeId}_wrap">
          <div class="tech-table" id="${safeId}_table"></div>
          <div class="tags-row">
            <input type="text" id="${safeId}_input" list="${escapeHtml(listId)}" ${ph} />
            <button type="button" id="${safeId}_add" class="btn-copy btn-add">Adicionar</button>
          </div>
        </div>
        <input type="hidden" id="${safeId}" value="" />
      </div>
    `;
  }

  if (type === "materials") {
    const materialsData = [...(SCHEMA.lists.materials || [])].sort((a, b) => (a.name || "").localeCompare(b.name || "", "pt-BR", { sensitivity: "base" }));
    const listId2 = `${id}_datalist`;
    return `<div>
      <label>${safeLabel}</label>
      <div class="materials-wrap" id="${safeId}_wrap">
        <div class="materials-list" id="${safeId}_list">
          <p class="materials-empty">Nenhum material adicionado</p>
        </div>
        <div class="materials-add">
          <input type="text" id="${safeId}_search" list="${listId2}" placeholder="Digite para buscar material..." style="flex:1;min-width:200px;padding:8px;border:1px solid var(--border-2);border-radius:4px;font-size:12px">
          <datalist id="${listId2}">${materialsData.map(m => `<option value="${escapeHtml(m.name)}"></option>`).join("")}</datalist>
          <input type="number" id="${safeId}_qty" placeholder="Qtd" min="0.1" step="0.1">
          <button type="button" id="${safeId}_add_btn" class="btn-copy btn-add">Adicionar</button>
        </div>
      </div>
      <input type="hidden" id="${safeId}" value="[]" />
    </div>`;
  }


  // ====== Subcausa (select din√¢mico) dependente de uma CAUSA ======
  if (type === "subcause_dynamic") {
    const dep = field.dependsOn || "";
    return `
      <div id="${safeId}_wrap" style="display:none">
        <label for="${safeId}">${safeLabel}</label>
        <select id="${safeId}" data-depends="${escapeHtml(dep)}">
          <option value="">-- Selecione a Subcausa --</option>
        </select>
        <div class="mini" id="${safeId}_hint" style="margin-top:6px"></div>
      </div>
    `;
  }

  const inputType = escapeHtml(type || "text");
  // ‚úÖ Desativar autocomplete do navegador apenas nos 2 campos de endere√ßo
  const disableBrowserAutocomplete =
    (id === "recuperacao_endereco" || id === "cto_defeito_endereco")
      ? `autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"`
      : "";

  return `<div><label for="${safeId}">${safeLabel}</label><input type="${inputType}" id="${safeId}" ${ph} ${val} ${ro} ${im} ${st} ${disableBrowserAutocomplete} /></div>`;
}

function renderForm(fields) {
  const rows = []; let buffer = []; let currentGroup = null;
  function flush(group) { if (!buffer.length) return; rows.push(`<div class="${groupClass(group)}">${buffer.join("")}</div>`); buffer = []; }
  for (const f of fields) {
    const g = f.group || "two";
    if (currentGroup === null) currentGroup = g;
    if (g !== currentGroup) { flush(currentGroup); currentGroup = g; }
    buffer.push(renderField(f));
  }
  flush(currentGroup);
  return rows.join("");
}

function getCheckedValue(name) { return document.querySelector(`input[name="${CSS.escape(name)}"]:checked`)?.value || ""; }
function getValueById(id) { const el = $(id); if (!el) return ""; if (el.tagName === "SELECT") return el.value || ""; return (el.value ?? "").toString(); }

function collectData(typeDef) {
  const data = {};
  for (const f of SCHEMA.baseFields) {
    if (f.type === "radio") data[f.id] = getCheckedValue(f.name || f.id);
    else data[f.id] = (getValueById(f.id).trim?.() ?? getValueById(f.id));
  }
  for (const f of (typeDef?.fields || [])) {
    if (f.type === "radio") data[f.id] = getCheckedValue(f.name || f.id);
    else data[f.id] = (getValueById(f.id).trim?.() ?? getValueById(f.id));
  }
  return data;
}

function hideOutput() { $("output").classList.remove("active"); $("outputText").innerHTML = ""; $("successMessage").classList.remove("show"); }
function showOutput(html) { $("outputText").innerHTML = html; $("output").classList.add("active"); $("output").scrollIntoView({ behavior: "smooth" }); }

function clearTypeFields(typeDef) {
  if (!typeDef) return;
  for (const f of typeDef.fields) {
    if (!!f.readonly) continue;
    if (f.type === "radio") { const nm = f.name || f.id; document.querySelectorAll(`input[name="${CSS.escape(nm)}"]`).forEach(r => r.checked = false); continue; }
    const el = $(f.id); if (!el) continue;
    if (f.type === "materials") { el.value = "[]"; el.__clearMaterials && el.__clearMaterials(); continue; }
    if (f.type === "tags") { el.value = ""; el.__clearTags && el.__clearTags(); continue; }
    if (el.tagName === "SELECT") el.selectedIndex = 0; else el.value = "";
  }
  hideOutput();
}

// ====== Busca de Endere√ßo (sugest√µes + hist√≥rico) ======
const PREFIXOS_VIA = ["Rua", "Av.", "Avenida", "Travessa", "Estrada", "Rodovia", "R.", "Alameda", "Largo"];
const ADDRESS_DB = [];
const ADR_HIST_KEY = "adr_hist";
function getAdrHistory() { try { return JSON.parse(localStorage.getItem(ADR_HIST_KEY) || "[]"); } catch { return []; } }
function pushAdrHistory(addr) { const a=(addr||"").trim(); if(!a) return; const hist=getAdrHistory().filter(x=>x!==a); hist.unshift(a); localStorage.setItem(ADR_HIST_KEY, JSON.stringify(hist.slice(0,50))); }
function buildAddressSuggestions(query){ const q=(query||"").trim().toLowerCase(); const hist=getAdrHistory(); const base=ADDRESS_DB.slice(); const starter = (!q ? PREFIXOS_VIA.map(p => p+" ") : []); const match=(arr)=>arr.filter(x=>x.toLowerCase().includes(q)); const final=[...starter, ...match(hist), ...match(base)].filter((v,i,self)=>self.indexOf(v)===i); if(q && !q.includes("porto alegre") && !/ - [A-Za-z√Ä-√∫\s]+$/.test(q)){ final.push((query||"").replace(/\s*$/, "") + " - Porto Alegre"); } return final.slice(0,20); }
function attachAddressSuggest(inputId){
  const input = document.getElementById(inputId);
  if (!input) return;

  // Wrapper s√≥ para posicionar o bot√£o abaixo do campo
  const wrap = document.createElement("div");
  wrap.className = "suggest-box";
  input.parentNode.insertBefore(wrap, input);
  wrap.appendChild(input);

  // Somente o bot√£o "Buscar no mapa"
  const tools = document.createElement("div");
  tools.style.display = "flex";
  tools.style.justifyContent = "space-between";
  tools.style.gap = "8px";
  tools.style.marginTop = "6px";

  const btnMaps = document.createElement("button");
  btnMaps.type = "button";
  btnMaps.className = "btn-copy";
  btnMaps.style.padding = "6px 10px";
  btnMaps.textContent = "üîé Buscar no mapa";
  btnMaps.addEventListener("click", () => {
    const q = input.value || "";
    if (!q.trim()) return alert("Digite um endere√ßo para pesquisar no mapa.");
    window.open("https://www.google.com/maps/search/" + encodeURIComponent(q), "_blank");
  });

  tools.appendChild(btnMaps);
  wrap.appendChild(tools);

  // ‚úÖ Para aqui: sem lista, sem hist√≥rico, sem autocomplete
  return;
}
function initAddressSuggestForType(typeDef){ if(!typeDef || !typeDef.fields) return; const addressFieldIds = typeDef.fields.filter(f => ["recuperacao_endereco", "cto_defeito_endereco"].includes(f.id)).map(f => f.id); setTimeout(()=>{ addressFieldIds.forEach(attachAddressSuggest); }, 0); }


// ====== Subcausa din√¢mica (Carimbo 4): depende da CAUSA selecionada ======
function initSubcauseDynamic(typeDef){
  const fields = (typeDef?.fields || []).filter(f => f.type === "subcause_dynamic");
  if (!fields.length) return;

  fields.forEach(f => {
    const subId = f.id;
    const wrap = document.getElementById(`${subId}_wrap`);
    const sel  = document.getElementById(subId);
    const hint = document.getElementById(`${subId}_hint`);
    const causeId = f.dependsOn;
    const causeEl = document.getElementById(causeId);
    if(!wrap || !sel || !causeEl) return;

    // Para Carimbo 4: se a causa estiver vazia, sugere a √∫ltima do Carimbo 3
    if (typeDef.id === "certificacao") {
      const last = getLastCause();
      if (!causeEl.value && last) causeEl.value = last;
    }

    function refresh(){
      const cause = (causeEl.value || "").trim() || getLastCause();
      const options = SUBCAUSES[cause] || [];

      if(!cause){
        wrap.style.display = "none";
        sel.innerHTML = `<option value="">-- Selecione a Subcausa --</option>`;
        sel.value = "";
        if(hint) hint.textContent = "Causa (Carimbo 3) n√£o informada";
        return;
      }

      // Se a causa n√£o tiver subcausas, esconde subcausa
      if(!options.length){
        wrap.style.display = "none";
        sel.innerHTML = `<option value="">-- Selecione a Subcausa --</option>`;
        sel.value = "";
        if(hint) hint.textContent = `Causa selecionada: ${cause} (sem subcausa)`;
        return;
      }

      sel.innerHTML = `<option value="">-- Selecione a Subcausa --</option>` +
        options.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");

      wrap.style.display = "block";
      if(hint) hint.textContent = `Causa selecionada: ${cause} | √öltima (Carimbo 3): ${getLastCause() || "-"}`;
    }

    causeEl.addEventListener("change", refresh);
    refresh();
  });
}

// ====== GEO Utils (uso exclusivo no carimbo Certifica√ß√£o) ======
function formatLocalDateTime(ts = Date.now()) { try { return new Date(ts).toLocaleString("pt-BR", { hour12:false }); } catch { return new Date().toISOString(); } }
function getCurrentPositionText({ timeoutMs = 8000, enableHighAccuracy = true } = {}) { return new Promise((resolve) => { if (!("geolocation" in navigator)) { return resolve("indispon√≠vel"); } const onSuccess = (pos) => { const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords || {}; if (lat == null || lng == null) return resolve("indispon√≠vel"); const latStr = Number(lat).toFixed(6); const lngStr = Number(lng).toFixed(6); const accStr = (acc != null) ? ` ¬±${Math.round(acc)}m` : ""; const when = formatLocalDateTime(Date.now()); resolve(`${latStr}, ${lngStr}${accStr} | ${when}`); }; const onError = () => resolve("indispon√≠vel"); try { navigator.geolocation.getCurrentPosition(onSuccess, onError, { enableHighAccuracy, timeout: timeoutMs, maximumAge: 0 }); } catch { resolve("indispon√≠vel"); } }); }

function validateRequired(typeDef, data) {
  const labels = new Map();
  for (const f of SCHEMA.baseFields) labels.set(f.id, f.label || f.id);
  for (const f of typeDef.fields) labels.set(f.id, f.label || f.id);

  const typeId = typeDef.id;
  const req = [...(REQUIRED.base || []), ...((REQUIRED[typeId]) || [])];
  const missing = [];

  for (const id of req) {
    const val = (data[id] ?? "").toString().trim();
    if (!val) missing.push(labels.get(id) || id);
  }

  // Regras espec√≠ficas
  if (typeId === "certificacao") {
    const geo = (data.certificacao_geo || "").trim();
    const hasCoords = /-?\d+\.\d+\s*,\s*-?\d+\.\d+/.test(geo);
    if (!geo || geo.toLowerCase().includes("indispon√≠vel") || !hasCoords) {
      if (!missing.includes("Geolocaliza√ß√£o (GPS)")) missing.push("Geolocaliza√ß√£o (GPS)");
    }
  }

  


  // ‚úÖ Carimbo 4 (Certifica√ß√£o): Causa pode ser selecionada aqui, mas sugere a √∫ltima do Carimbo 3
  if (typeId === "certificacao") {
    const causeSel = (data.certificacao_causa || "").trim();
    const cause3 = getLastCause();
    const cause = causeSel || cause3;

    if (!cause) {
      if (!missing.includes("Causa (Carimbo 4)")) missing.push("Causa (Carimbo 4)");
    }

    const opts = SUBCAUSES[cause] || [];
    if (opts.length > 0) {
      const sub = (data.certificacao_subcausa || "").trim();
      if (!sub) {
        if (!missing.includes("Subcausa")) missing.push("Subcausa");
      }
    }
  }

// Campos do tipo datalist: obrigar sele√ß√£o da lista (sem digita√ß√£o livre)
const allFields = [...(SCHEMA.baseFields || []), ...(typeDef.fields || [])];
allFields.filter(f=>f.type==='datalist').forEach(f=>{
  const val = (data[f.id] || '').toString().trim();
  if(!val) return;
  const allowed = getAllowedListForField(f);
  if(allowed.length && !isValueInAllowed(val, allowed)){
    const lab = (f.label || f.id);
    if(!missing.includes(lab)) missing.push(lab + ' (selecione da lista)');
  }
});

return missing;
}

function renderDynamic(typeId) {
  const root = $("dynamicRoot");
  root.innerHTML = "";
  if (!typeId) { root.innerHTML = `<div class="section"><div class="hint">Selecione um tipo de carimbo acima para ver os campos espec√≠ficos.</div></div>`; hideOutput(); return; }
  const typeDef = SCHEMA.types.find(t => t.id === typeId);
  if (!typeDef) return;
  root.innerHTML = `<div class="section"><div class="section-title">${escapeHtml(typeDef.title)}</div>${renderForm(typeDef.fields)}<div class="actions"><button class="btn-generate" id="btnGenerate" type="button">Gerar Carimbo</button><button class="btn-clear" id="btnClear" type="button">Limpar Formul√°rio</button></div></div>`;

  $("btnGenerate").addEventListener("click", async () => {
    let data = collectData(typeDef);



    // ‚úÖ Carimbo 3 (Recupera√ß√£o): salva a Causa selecionada para uso no Carimbo 4
    if (typeDef.id === "recuperacao") {
      setLastCause(data.recuperacao_causa || "");
    }
    // Captura GEO apenas para Certifica√ß√£o (obrigat√≥rio)
    if (typeDef.id === "certificacao") {
      try { data.certificacao_geo = await getCurrentPositionText({ timeoutMs: 8000, enableHighAccuracy: true }); }
      catch { data.certificacao_geo = "indispon√≠vel"; }
    }

    const missing = validateRequired(typeDef, data);
    if (missing.length > 0) {
      alert("Preencha os campos obrigat√≥rios antes de gerar o carimbo:\n\n- " + missing.join("\n- "));
      hideOutput();
      return;
    }

    const html = linesToSafeHtml(typeDef.stamp(data));
    showOutput(html);
  });

  $("btnClear").addEventListener("click", () => clearTypeFields(typeDef));

  setTimeout(() => {
    for (const f of typeDef.fields) {
      if (f.type === "materials") initMaterialsField(f.id);
      if (f.type === "file") registerFileInput(f.id);
    }
    attachDatalistEnforcement(typeDef.fields);
    initAddressSuggestForType(typeDef);

    // ‚úÖ Subcausa din√¢mica (Carimbo 4)
    initSubcauseDynamic(typeDef);

    // ‚úÖ Atualiza a Causa salva ao trocar no Carimbo 3
    if (typeDef.id === "recuperacao") {
      const el = document.getElementById("recuperacao_causa");
      if (el) el.addEventListener("change", () => setLastCause(el.value || ""));
    }
  }, 0);
}

// T√©cnicos (tabela)
function initTechsTableField(fieldId, { delimiter = " / " } = {}) {
  const input = document.getElementById(`${fieldId}_input`);
  const addBtn = document.getElementById(`${fieldId}_add`);
  const tableWrap = document.getElementById(`${fieldId}_table`);
  const hidden = document.getElementById(fieldId);
  if (!input || !addBtn || !tableWrap || !hidden) return;
  const state = { items: [] };
  const syncHidden = () => { hidden.value = state.items.map(x => x.name).join(delimiter); };
  const syncFirstPhone = () => { const telInput = document.getElementById("tecnico_tel"); if (!telInput) return; const first = state.items[0]; telInput.value = first ? formatPhoneBR(first.phone) : ""; };
  const render = () => {
    tableWrap.innerHTML = "";
    if (state.items.length === 0) { tableWrap.innerHTML = `<div class="muted">Nenhum t√©cnico adicionado</div>`; return; }
    const table = document.createElement("table");
    const header = table.insertRow();
    ["MATR√çCULA", "COLABORADOR", ""].forEach(t => { const th = document.createElement("th"); th.textContent = t; header.appendChild(th); });
    state.items.forEach((it, idx) => {
      const row = table.insertRow();
      row.insertCell().textContent = it.matricula || "";
      row.insertCell().textContent = it.name || "";
      const actions = row.insertCell(); actions.style.textAlign = "center";
      const btn = document.createElement("button"); btn.type = "button"; btn.className = "btn-x"; btn.textContent = "‚úï"; btn.title = "Remover";
      btn.addEventListener("click", () => { state.items.splice(idx, 1); syncHidden(); syncFirstPhone(); render(); });
      actions.appendChild(btn);
    });
    tableWrap.appendChild(table);
  };
  const addValue = () => {
    const raw = (input.value || "").trim(); if (!raw) return;
    const rec = (SCHEMA.lists.techDirectory || []).find(t => normalizeName(t.name) === normalizeName(raw)) || (SCHEMA.lists.techDirectory || []).find(t => String(t.matricula || "").trim() === raw) || (SCHEMA.lists.techDirectory || []).find(t => (t.phone || "").replace(/\D/g, "") === raw.replace(/\D/g, ""));
    if (!rec) { alert("Colaborador n√£o encontrado. Selecione da lista ou informe matr√≠cula/telefone v√°lido."); return; }
    const key = (rec.matricula || normalizeName(rec.name));
    const exists = state.items.some(x => (x.matricula || normalizeName(x.name)) === key);
    if (exists) { input.value = ""; return; }
    state.items.push({ name: rec.name, phone: rec.phone, matricula: rec.matricula });
    input.value = ""; syncHidden(); syncFirstPhone(); render(); input.focus();
  };
  addBtn.addEventListener("click", addValue);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); addValue(); } if (e.key === "Backspace" && !input.value && state.items.length) { state.items.pop(); syncHidden(); syncFirstPhone(); render(); } });
  hidden.__clearTags = () => { state.items = []; syncHidden(); syncFirstPhone(); render(); };
  syncHidden(); syncFirstPhone(); render();
}

function initMaterialsField(fieldId) {
  const searchInput = document.getElementById(`${fieldId}_search`);
  const qty = document.getElementById(`${fieldId}_qty`);
  const addBtn = document.getElementById(`${fieldId}_add_btn`);
  const list = document.getElementById(`${fieldId}_list`);
  const hidden = document.getElementById(fieldId);
  if (!searchInput || !qty || !addBtn || !list || !hidden) return;
  const state = { items: [] };
  const syncHidden = () => { hidden.value = JSON.stringify(state.items); };
  const render = () => {
    list.innerHTML = "";
    if (state.items.length === 0) { list.innerHTML = `<p class="materials-empty">Nenhum material adicionado</p>`; return; }
    const table = document.createElement("table");
    const header = table.insertRow();
    ["Material", "Qtd", "Un", ""].forEach(text => { const th = document.createElement("th"); th.textContent = text; header.appendChild(th); });
    state.items.forEach((item, idx) => {
      const row = table.insertRow();
      row.insertCell().textContent = item.name;
      row.insertCell().textContent = item.quantity;
      row.insertCell().textContent = item.unit;
      const c4 = row.insertCell(); c4.style.textAlign = "center";
      const btn = document.createElement("button"); btn.type = "button"; btn.textContent = "‚úï"; btn.style.background = "transparent"; btn.style.border = "none"; btn.style.cursor = "pointer"; btn.style.color = "var(--accent)"; btn.style.fontWeight = "700";
      btn.addEventListener("click", () => { state.items.splice(idx, 1); syncHidden(); render(); });
      c4.appendChild(btn);
    });
    list.appendChild(table);
  };
  const addMaterial = () => {
    const materialKey = searchInput.value.trim();
    const quantity = parseFloat(qty.value);
    if (!materialKey || !quantity || quantity <= 0) { alert("Digite um material e informe a quantidade v√°lida"); return; }
    const materialData = SCHEMA.lists.materials.find(m => m.name === materialKey) || SCHEMA.lists.materials.find(m => m.code === materialKey);
    if (!materialData) { alert("Material n√£o encontrado. Selecione da lista."); return; }
    state.items.push({ name: materialData.name, quantity: quantity, unit: materialData.unit, code: materialData.code });
    searchInput.value = ""; qty.value = ""; syncHidden(); render(); searchInput.focus();
  };
  addBtn.addEventListener("click", addMaterial);
  qty.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); addMaterial(); } });
  hidden.__clearMaterials = () => { state.items = []; syncHidden(); render(); };
  syncHidden(); render();
}

async function copyToClipboard() {
  const text = $("outputText").innerText || "";
  if (!text.trim()) return alert("Nenhum carimbo gerado. Gere o carimbo primeiro.");
  try { await navigator.clipboard.writeText(text); } catch {
    const ta = document.createElement("textarea");
    ta.value = text; ta.setAttribute("readonly", ""); ta.style.position = "fixed"; ta.style.left = "-9999px";
    document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
  }
  $("successMessage").classList.add("show");
  setTimeout(() => $("successMessage").classList.remove("show"), 3000);
}

function sendToWhatsApp() {
  const text = $("outputText").innerText || "";
  if (!text.trim()) return alert("Nenhum carimbo gerado. Gere o carimbo primeiro.");

  const typeId = $("carimbo_tipo")?.value || "";
  const files = (typeId === "certificacao") ? getFiles("certificacao_anexos") : [];

  // ‚úÖ No celular, tenta compartilhar texto + anexos via Web Share (funciona com WhatsApp quando suportado)
  if (files.length && navigator.share && navigator.canShare) {
    try {
      if (navigator.canShare({ files })) {
        navigator.share({ title: "Carimbo", text, files }).catch(() => {
          window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
        });
        return;
      }
    } catch (e) {
      // segue fallback
    }
  }

  // Fallback (desktop/whatsapp web): somente texto
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
  if (files.length) {
    setTimeout(() => alert("‚ö†Ô∏è Seu navegador/WhatsApp Web n√£o permite anexar arquivos automaticamente. Anexe manualmente os arquivos selecionados."), 300);
  }
}

function initBase() {
  // Datalists com strings (evita [object Object])
  buildDatalist("supervisorList", SCHEMA.lists.supervisors.map(s => s.name));
  buildDatalist("analistaList", SCHEMA.lists.analysts);
  buildDatalist("tecnicoList", SCHEMA.lists.technicians);
  buildDatalist("siteList", SCHEMA.lists.sites);

  $("baseForm").innerHTML = renderForm(SCHEMA.baseFields);
  attachDatalistEnforcement(SCHEMA.baseFields);

  initTechsTableField("tecnicos", { delimiter: " / " });
  $("carimbo_tipo").addEventListener("change", (e) => renderDynamic(e.target.value));
  $("supervisor").addEventListener("input", function() { const tel = supervisorPhones[normalizeName(this.value)]; $("supervisor_tel").value = tel ?? ""; });
  $("btnCopy").addEventListener("click", copyToClipboard);
  $("btnWhats").addEventListener("click", sendToWhatsApp);
  renderDynamic($("carimbo_tipo").value);
}

document.addEventListener("DOMContentLoaded", initBase);
  </script>
</body>
</html>
